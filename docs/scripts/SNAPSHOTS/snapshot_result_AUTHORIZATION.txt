================================================================================
AUTHENTICATION + AUTHORIZATION SNAPSHOT
Generated: 2026-02-14
Repository: ASC-Inventory
================================================================================

SECTION 1: AUTHENTICATION ESTABLISHMENT
================================================================================

Provider: JWT (via @fastify/jwt)
Implementation: C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\auth.ts
Secret source: process.env.JWT_SECRET (fallback: dev-secret-change-in-production)
Token lifespan: 24 hours
Token algorithm: HS256 (implicit @fastify/jwt default)

Server-side boundaries:
C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\auth.ts
- fastify.decorate('authenticate') - JWT verification decorator
- requireRoles(...allowedRoles) - preHandler for role-based checks
- requireCapabilities(...requiredCaps) - preHandler for capability-based checks
- requirePlatformAdmin() - preHandler for PLATFORM_ADMIN-only routes
- requireTenantContext() - preHandler rejecting null facilityId

Client-side boundaries:
C:\Users\missp\source\repos\ASC-Inventory\apps\web\src\lib\auth.tsx
- AuthProvider - React context managing user/token state
- useAuth() - hook for authentication state
- useAccessControl() - hook for role/capability/feature access
C:\Users\missp\source\repos\ASC-Inventory\apps\web\src\app\components\AuthGuard.tsx
- AuthGuard - redirects unauthenticated users to /login
C:\Users\missp\source\repos\ASC-Inventory\apps\web\src\components\AccessGuard.tsx
- AccessGuard - conditional UI rendering based on roles/capabilities

Token storage:
Client: localStorage key 'asc_token'
Server: No server-side session storage (stateless JWT)

Login endpoints:
POST /auth/login (tenant users) - C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\routes\auth.routes.ts
POST /auth/login (platform admin) - special facilityKey = 'PLATFORM'
GET /auth/me - verify token and fetch current user
POST /auth/logout - log event and clear client-side state

Clinic API Key Authentication:
Implementation: C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\clinic-auth.ts
Header: X-Clinic-Key
Mechanism: 64-char hex key, first 8 chars = prefix for lookup, full key verified via HMAC-SHA256
Secret: process.env.CLINIC_KEY_SECRET (fallback: dev-clinic-key-secret-change-in-production)
Middleware: requireClinicAuth - sets request.clinicContext on success
Context fields: clinicId, clinicName

PHI-specific authentication:
Implementation: C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\phi-guard.ts
Requires: JWT authentication PLUS X-Access-Purpose header
Purposes: CLINICAL_CARE, SCHEDULING, BILLING, AUDIT, EMERGENCY
Emergency access: requires X-Emergency-Justification header (min 10 chars), rate limited to 10/hour per user
Context decoration: request.phiContext = { classification, purpose, organizationIds, isEmergency, auditLogId }

================================================================================
SECTION 2: SESSION/USER MODEL SHAPE
================================================================================

JWT Payload (JwtPayload):
Source: C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\auth.ts
Fields:
userId: string
facilityId: string | null (null for PLATFORM_ADMIN)
username: string
email: string | null
name: string
role: UserRole (deprecated, kept for backward compat)
roles: UserRole[] (canonical source of truth for authorization)

Client-side user shape (LoginResponse['user']):
Source: C:\Users\missp\source\repos\ASC-Inventory\apps\web\src\lib\api\auth.ts
Fields:
id: string
username: string
email: string | null
name: string
role: string (primary role, first in roles array)
roles: string[]
facilityId: string | null
facilityName: string

Database schema (app_user table):
UNKNOWN - inferred from query in auth.routes.ts:
id, facility_id, username, email, name, role, roles, password_hash, active, created_at, updated_at

Role normalization:
Function: getUserRoles(user: JwtPayload) -> UserRole[]
Location: C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\auth.ts
Logic: returns user.roles if populated, else falls back to [user.role] with error logging
Error code: AUTH_LEGACY_ROLE_FALLBACK (tracked for removal when no JWTs use legacy format)

Persona (UX-only, not authorization):
Source: C:\Users\missp\source\repos\ASC-Inventory\packages\domain\src\persona.ts
Storage: localStorage key 'asc_active_persona'
Header: X-Active-Persona (untrusted, audit/logging only)
Purpose: UI session focus ("active hat"), does NOT grant or restrict permissions
Authorization truth: UNION of all roles/capabilities regardless of active persona

================================================================================
SECTION 3: ROLES AND CAPABILITIES
================================================================================

Role enumeration (UserRole):
Source: C:\Users\missp\source\repos\ASC-Inventory\packages\domain\src\types.ts lines 39-48
PLATFORM_ADMIN (no-tenant identity, Control Plane only)
ADMIN
SCHEDULER
INVENTORY_TECH
CIRCULATOR
SURGEON
SCRUB
ANESTHESIA

Capability enumeration:
Source: C:\Users\missp\source\repos\ASC-Inventory\packages\domain\src\types.ts lines 132-174
CASE_VIEW
CASE_CREATE
CASE_UPDATE
CASE_APPROVE
CASE_REJECT
CASE_ASSIGN_ROOM
CASE_ACTIVATE
CASE_CHECKIN_PREOP
CASE_DELETE
CASE_CANCEL
CASE_PREFERENCE_CARD_LINK
VERIFY_SCAN
CHECKLIST_ATTEST
OR_DEBRIEF
OR_TIMEOUT
INVENTORY_READ
INVENTORY_CHECKIN
INVENTORY_MANAGE
USER_MANAGE
LOCATION_MANAGE
CATALOG_MANAGE
REPORTS_VIEW
SETTINGS_MANAGE
PHI_CLINICAL_ACCESS
PHI_WRITE_CLINICAL
PHI_PATIENT_SEARCH
PHI_BILLING_ACCESS
PHI_AUDIT_ACCESS
ORG_MANAGE
ORG_AFFILIATION_MANAGE
SURGERY_REQUEST_REVIEW
SURGERY_REQUEST_CONVERT
FINANCIAL_READINESS_VIEW
FINANCIAL_READINESS_EDIT
PLATFORM_ADMIN
PLATFORM_CONFIG_VIEW
PLATFORM_CONFIG_MANAGE

Role-to-capability mapping (ROLE_CAPABILITIES):
Source: C:\Users\missp\source\repos\ASC-Inventory\packages\domain\src\types.ts lines 183-212
PLATFORM_ADMIN: PLATFORM_ADMIN, PLATFORM_CONFIG_VIEW, PLATFORM_CONFIG_MANAGE
SCRUB: CASE_VIEW, VERIFY_SCAN, CHECKLIST_ATTEST, PHI_CLINICAL_ACCESS, PHI_PATIENT_SEARCH
CIRCULATOR: CASE_VIEW, CHECKLIST_ATTEST, OR_DEBRIEF, OR_TIMEOUT, CASE_CHECKIN_PREOP, PHI_CLINICAL_ACCESS, PHI_PATIENT_SEARCH
INVENTORY_TECH: CASE_VIEW, INVENTORY_READ, INVENTORY_CHECKIN, PHI_CLINICAL_ACCESS, PHI_PATIENT_SEARCH
ADMIN: USER_MANAGE, LOCATION_MANAGE, CATALOG_MANAGE, INVENTORY_MANAGE, REPORTS_VIEW, SETTINGS_MANAGE, CASE_VIEW, CASE_CREATE, CASE_UPDATE, CASE_APPROVE, CASE_REJECT, CASE_ASSIGN_ROOM, CASE_ACTIVATE, CASE_CHECKIN_PREOP, CASE_DELETE, CASE_CANCEL, CASE_PREFERENCE_CARD_LINK, PHI_CLINICAL_ACCESS, PHI_WRITE_CLINICAL, PHI_PATIENT_SEARCH, PHI_AUDIT_ACCESS, ORG_MANAGE, ORG_AFFILIATION_MANAGE, SURGERY_REQUEST_REVIEW, SURGERY_REQUEST_CONVERT, FINANCIAL_READINESS_VIEW, FINANCIAL_READINESS_EDIT
SURGEON: CASE_VIEW, CASE_CREATE, CASE_UPDATE, CASE_CANCEL, CASE_PREFERENCE_CARD_LINK, CHECKLIST_ATTEST, PHI_CLINICAL_ACCESS, PHI_PATIENT_SEARCH
SCHEDULER: CASE_VIEW, CASE_CREATE, CASE_UPDATE, CASE_APPROVE, CASE_REJECT, CASE_ASSIGN_ROOM, CASE_ACTIVATE, CASE_CHECKIN_PREOP, CASE_CANCEL, PHI_CLINICAL_ACCESS, PHI_PATIENT_SEARCH, SURGERY_REQUEST_REVIEW
ANESTHESIA: CASE_VIEW, CHECKLIST_ATTEST, PHI_CLINICAL_ACCESS, PHI_PATIENT_SEARCH

Capability derivation:
Function: deriveCapabilities(roles: UserRole[]) -> Capability[]
Source: C:\Users\missp\source\repos\ASC-Inventory\packages\domain\src\types.ts lines 217-225
Logic: UNION of all capabilities from all roles (Set deduplication)

PHI classification to capability mapping:
Source: C:\Users\missp\source\repos\ASC-Inventory\packages\domain\src\types.ts lines 106-110
PHI_CLINICAL -> PHI_CLINICAL_ACCESS
PHI_BILLING -> PHI_BILLING_ACCESS
PHI_AUDIT -> PHI_AUDIT_ACCESS

================================================================================
SECTION 4: ENFORCEMENT POINTS
================================================================================

API Middleware (Fastify preHandlers):
C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\auth.ts
- fastify.authenticate - verifies JWT, sets request.user, returns 401 if invalid
- requireRoles(...allowedRoles) - verifies JWT, checks ANY role match, returns 403 if denied
- requireCapabilities(...requiredCaps) - verifies JWT, derives capabilities, checks ANY match, returns 403 if denied
- requirePlatformAdmin() - verifies JWT, checks PLATFORM_ADMIN in roles[], returns 403 if denied
- requireTenantContext() - verifies JWT, checks facilityId !== null, returns 403 if denied

Pre-built role helpers:
C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\auth.ts lines 144-151
requireAdmin = requireRoles('ADMIN')
requireScheduler = requireRoles('ADMIN', 'SCHEDULER')
requireInventoryTech = requireRoles('ADMIN', 'INVENTORY_TECH')
requireCirculator = requireRoles('ADMIN', 'CIRCULATOR', 'INVENTORY_TECH')
requireSurgeon = requireRoles('SURGEON')
requireAnyStaff = requireRoles('ADMIN', 'SCHEDULER', 'INVENTORY_TECH', 'CIRCULATOR')
requireAttestation = requireRoles('ADMIN', 'CIRCULATOR', 'INVENTORY_TECH')

PHI Guard middleware:
C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\phi-guard.ts
requirePhiAccess(classification: PhiClassification, options?: { evaluateCase?: boolean, caseIdFrom?: string })
Steps:
1. Validate X-Access-Purpose header (DENY if missing/invalid)
2. Emergency handling: validate X-Emergency-Justification, rate limit 10/hour
3. Resolve user org affiliations (SKIP for EMERGENCY)
4. Check PHI capability from roles[] (NOT skipped for EMERGENCY)
5. Clinical care window enforcement (if PHI_CLINICAL + CLINICAL_CARE/SCHEDULING, NOT EMERGENCY)
6. Case-level evaluation: verify facility match, org affiliation OR grant OR purpose override (SKIP for EMERGENCY)
7. Log all attempts to phi_access_audit_log
Returns 403 with specific denial reasons, decorates request.phiContext on success

API route examples:
C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\routes\platform.routes.ts
- All routes use requirePlatformAdmin()
C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\routes\cases.routes.ts
- List cases: [fastify.authenticate, requirePhiAccess('PHI_CLINICAL')]
- Get case: [fastify.authenticate, requirePhiAccess('PHI_CLINICAL', { evaluateCase: true })]
- Update case: [requireCapabilities('CASE_UPDATE'), requirePhiAccess('PHI_CLINICAL', { evaluateCase: true })]
C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\routes\admin-surgery-requests.routes.ts
- All routes use requireCapabilities('SURGERY_REQUEST_REVIEW') or requireCapabilities('SURGERY_REQUEST_CONVERT')

Client-side layouts:
C:\Users\missp\source\repos\ASC-Inventory\apps\web\src\app\(app)\layout.tsx
- Wraps all authenticated routes with AuthGuard (redirects to /login if not authenticated)
C:\Users\missp\source\repos\ASC-Inventory\apps\web\src\app\(app)\platform\layout.tsx
- Checks hasRole('PLATFORM_ADMIN'), renders access denied page if false

Client-side components:
C:\Users\missp\source\repos\ASC-Inventory\apps\web\src\components\AccessGuard.tsx
- Props: requiredRoles?: Role[], requiredCapabilities?: Capability[], fallback?: ReactNode
- Logic: show children if user has ANY required role OR ANY required capability
- No requirements = always show
- Renders fallback (default null) if denied

Feature access control:
C:\Users\missp\source\repos\ASC-Inventory\apps\web\src\lib\access-control.ts
- FEATURES array defines all features with requiredRoles/requiredCapabilities
- checkFeatureAccess(feature, userRoles, userCapabilities) -> AccessDecision
- getAccessibleFeatures(userRoles, userCapabilities) -> { feature, decision }[]

API route registration pattern (sampled):
All routes use preHandler arrays with combinations of:
- fastify.authenticate
- requireRoles(...)
- requireCapabilities(...)
- requirePlatformAdmin()
- requireTenantContext()
- requirePhiAccess(...)
- requireClinicAuth (for clinic-facing API routes)

HTTP method enforcement:
UNKNOWN - no explicit HTTP verb restrictions beyond standard REST patterns observed in route files

Network-level enforcement:
UNKNOWN - firewall/reverse proxy rules not defined in application code

================================================================================
SECTION 5: DEBUG/TRACE TOOLING
================================================================================

Debug Panel:
Location: C:\Users\missp\source\repos\ASC-Inventory\apps\web\src\app\(app)\dashboard\page.tsx
Features:
- Displays user roles (from debugInfo.roles)
- Displays derived capabilities (from debugInfo.capabilities)
- Feature access matrix table showing each feature, allowed status, and reason
- Copy debug JSON button (copies debugInfo to clipboard)
- Collapsible UI

Debug info generation:
Function: generateDebugInfo(userRoles, userCapabilities) -> DebugInfo
Source: C:\Users\missp\source\repos\ASC-Inventory\apps\web\src\lib\access-control.ts lines 342-361
Returns:
roles: Role[]
capabilities: Capability[]
featureDecisions: { featureId, featureTitle, allowed, reason }[]

Access decision reasoning:
Source: C:\Users\missp\source\repos\ASC-Inventory\apps\web\src\lib\access-control.ts lines 260-313
checkFeatureAccess returns AccessDecision with:
allowed: boolean
reason: string (e.g., "User has required role: ADMIN", "Missing required roles: ADMIN OR SCHEDULER")
matchedRole?: Role
matchedCapability?: Capability

Server-side logging:
Authentication events:
Service: logAuthEvent(context: AuthAuditContext)
Location: C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\services\auth-audit.service.ts
Logged to: auth_audit_log table
Events: LOGIN_SUCCESS, LOGIN_FAILED, LOGOUT
Fields: eventType, facilityId, userId, username, userRoles, success, failureReason, requestId, ipAddress, userAgent, createdAt

Authorization denials:
Code: AUTHZ_DENIED (request.log.warn)
Location: C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\auth.ts
Context: userId, facilityId, requiredRoles or requiredCapabilities
Logged in requireRoles and requireCapabilities preHandlers

PHI access audit:
Service: logPhiAccess(context: PhiAccessContext)
Location: C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\phi-guard.ts
Logged to: phi_access_audit_log table
Fields: userId, userRoles, facilityId, organizationIds, caseId, phiClassification, accessPurpose, outcome (ALLOWED/DENIED), denialReason, requestId, endpoint, httpMethod, isEmergency, emergencyJustification, breachContext

Legacy role fallback tracking:
Code: AUTH_LEGACY_ROLE_FALLBACK
Location: C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\auth.ts lines 54-63
Logged as ERROR when JWT has no roles[] array, falls back to user.role
Purpose: track removal readiness (remove when no occurrences seen for 30 days)

Platform access denials:
Code: PLATFORM_ACCESS_DENIED
Location: C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\auth.ts line 175
Logged when non-PLATFORM_ADMIN user attempts Control Plane route

Structured log codes:
AUTH_FAILED - authentication failure (invalid JWT)
LOGIN_FAILED - login attempt failed (user not found, bad password, account disabled, facility not found)
LOGIN_SUCCESS - successful login
LOGOUT - user logout
AUTHZ_DENIED - authorization denied (missing roles or capabilities)
PLATFORM_ACCESS_DENIED - Control Plane access denied
TENANT_CONTEXT_REQUIRED - tenant endpoint requires facilityId
PHI_ACCESS_DENIED - PHI access denied (various denialReasons)

Denial reasons (PHI):
MISSING_PURPOSE_HEADER
INVALID_PURPOSE:{value}
EMERGENCY_JUSTIFICATION_REQUIRED
EMERGENCY_RATE_LIMIT
AFFILIATION_RESOLUTION_ERROR
NO_ORG_AFFILIATIONS
MISSING_PHI_CAPABILITY
CASE_NOT_FOUND
CROSS_FACILITY_ACCESS
OUTSIDE_CLINICAL_WINDOW
CASE_ATTRIBUTION_MISSING
NO_CASE_ACCESS

Request correlation:
Field: requestId
Source: Fastify request.requestId (auto-generated)
Propagated to: all auth audit logs, PHI audit logs, error responses

================================================================================
SECTION 6: INCONSISTENCIES AND DUPLICATED LOGIC
================================================================================

Role normalization duplication:
apps/api/src/routes/auth.routes.ts lines 13-21 defines normalizeRoles helper
apps/api/src/plugins/auth.ts lines 49-64 defines getUserRoles helper
Both perform same normalization: roles[] array or fallback to [role]
Difference: getUserRoles logs AUTH_LEGACY_ROLE_FALLBACK error, auth.routes helper does not
Impact: auth.routes uses local helper for JWT generation, plugins/auth exports getUserRoles for preHandlers
No functional inconsistency, but logic is duplicated

Persona vs authorization confusion risk:
packages/domain/src/persona.ts states persona NEVER grants or restricts permissions
X-Active-Persona header sent to API as untrusted audit-only value
No enforcement of persona in authorization logic found
Consistent with stated policy, but documentation burden on developers to understand separation

Feature access enforcement split:
Client-side: AccessGuard component uses roles/capabilities to show/hide UI
Server-side: requireRoles/requireCapabilities middleware enforces access
No inconsistency found, but client-side checks are UX-only and can be bypassed (expected)
Comment in AccessGuard.tsx line 22 explicitly states "This is UX only â€” the API enforces real authorization"

PHI access purpose validation:
requirePhiAccess validates X-Access-Purpose header in all cases
Export endpoints additionally enforce AUDIT or BILLING purpose via validateExportPurpose
Source: C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\phi-guard.ts lines 234-248
Consistent layering: general purpose validation, then export-specific purpose restriction

Emergency access bypass scope:
Emergency bypasses: org affiliation check, clinical care window
Emergency does NOT bypass: facility context, PHI capability, rate limit
Documented in phi-guard.ts comments (lines 19-20)
Consistent with implementation

Clinical care window defaults:
Defined in packages/domain/src/types.ts lines 92-95
preOpDays: 7, postCompletionDays: 30
Overridable via config_registry (phi.clinical_care_window.pre_op_days, phi.clinical_care_window.post_completion_days)
Fallback to defaults if config lookup fails (non-blocking)
Source: C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\phi-guard.ts lines 184-203

PLATFORM_ADMIN facility context:
JWT payload: facilityId = null for PLATFORM_ADMIN
User record: facility_id IS NULL in app_user table
Login flow: special facilityKey = 'PLATFORM' triggers platform admin query
Consistent enforcement: requireTenantContext rejects facilityId === null
Platform routes use requirePlatformAdmin which checks role, not facilityId
No inconsistency found

Multi-role capability derivation:
Server: deriveCapabilities in packages/domain/src/types.ts (canonical)
Client: deriveCapabilities in apps/web/src/lib/access-control.ts (re-exports canonical)
Both use UNION logic via Set deduplication
Consistent

Access decision logic (client-side feature access):
checkFeatureAccess uses OR logic for roles and capabilities
If feature has requiredRoles AND requiredCapabilities, user needs ANY role OR ANY capability (not both)
Comment in access-control.ts line 23 documents this as intentional OR behavior
Consistent with implementation, though AND logic might be expected by some developers

Contract-based routes:
C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\routes\cases.routes.ts uses registerContractRoute
preHandler arrays still used for auth enforcement
Contract schema validates request/response shape, not authorization
No inconsistency, complementary systems

Token expiration handling:
JWT sign config: expiresIn '24h'
No refresh token mechanism found
Client clears token on 401 response from getMe call
Source: C:\Users\missp\source\repos\ASC-Inventory\apps\web\src\lib\auth.tsx lines 36-46
Expired tokens result in re-authentication via login flow
Consistent stateless JWT approach

Capability vs role checks in routes:
Some routes use requireRoles (e.g., requireScheduler)
Some routes use requireCapabilities (e.g., requireCapabilities('CASE_UPDATE'))
No routes mix both in same preHandler array
Pattern: use requireCapabilities for fine-grained actions, requireRoles for coarse-grained sections
Consistent with multi-role design: capabilities allow role-independent permission grants

PHI audit log race condition mitigation:
logPhiAccess returns Promise<auditLogId>
request.phiContext.auditLogReady = auditPromise for export event linking
Export logging awaits auditLogReady before writing phi_export_event
Source: C:\Users\missp\source\repos\ASC-Inventory\apps\api\src\plugins\phi-guard.ts lines 624-636, 261-270
Prevents race between fire-and-forget audit log and export log foreign key insert
Consistent defensive design

================================================================================
END OF SNAPSHOT
================================================================================
