AUTHORIZATION MATRIX SNAPSHOT
Generated: 2026-02-14
Scope: Implemented authorization model (roles, capabilities, enforcement)
Mode: READ-ONLY AUDIT

================================================================================
A) SOURCE OF TRUTH LOCATIONS
================================================================================

packages/domain/src/types.ts
  - UserRole enum definition (lines 39-48)
  - Capability type definition (lines 132-174)
  - ROLE_CAPABILITIES mapping (lines 183-212)
  - deriveCapabilities function (lines 217-225)

apps/api/src/plugins/auth.ts
  - JwtPayload interface (lines 12-20)
  - getUserRoles function (lines 49-64)
  - requireRoles preHandler (lines 96-116)
  - requireCapabilities preHandler (lines 121-141)
  - requireAdmin constant (line 144)
  - requireScheduler constant (line 145)
  - requireInventoryTech constant (line 146)
  - requireCirculator constant (line 147)
  - requireSurgeon constant (line 148)
  - requireAnyStaff constant (line 149)
  - requireAttestation constant (line 150)
  - requirePlatformAdmin preHandler (lines 161-183)
  - requireTenantContext preHandler (lines 190-211)
  - isPlatformAdmin type guard (lines 26-29)

apps/web/src/lib/access-control.ts
  - Client-side Role and Capability types (exported from @asc/domain)
  - FEATURES array with UI feature definitions (lines 35-227)
  - normalizeRoles function (lines 245-247)
  - deriveCapabilities function (lines 253-255)
  - checkFeatureAccess function (lines 261-313)
  - getAccessibleFeatures function (lines 318-326)

apps/web/src/lib/auth.tsx
  - useAccessControl hook (lines 92-122)
  - hasRole and hasCapability helpers (lines 118-119)

apps/web/src/components/AccessGuard.tsx
  - Client-side access guard component (lines 1-47)

apps/web/src/app/components/AuthGuard.tsx
  - Authentication guard (redirects to login if not authenticated) (lines 1-31)

apps/web/src/app/(app)/layout.tsx
  - Applies AuthGuard to all /app routes (lines 1-8)

apps/web/src/app/(app)/platform/layout.tsx
  - Client-side PLATFORM_ADMIN role check (lines 32-49)

apps/api/src/plugins/phi-guard.js
  - requirePhiAccess function (inferred from import statements in route files)

All API route files under apps/api/src/routes/*.routes.ts
  - Route-level enforcement via preHandler arrays

================================================================================
B) ROLES
================================================================================

PLATFORM_ADMIN
  Defined: packages/domain/src/types.ts line 40
  Purpose: No-tenant identity for platform operations

ADMIN
  Defined: packages/domain/src/types.ts line 41

SCHEDULER
  Defined: packages/domain/src/types.ts line 42

INVENTORY_TECH
  Defined: packages/domain/src/types.ts line 43

CIRCULATOR
  Defined: packages/domain/src/types.ts line 44

SURGEON
  Defined: packages/domain/src/types.ts line 45

SCRUB
  Defined: packages/domain/src/types.ts line 46

ANESTHESIA
  Defined: packages/domain/src/types.ts line 47

================================================================================
C) CAPABILITIES
================================================================================

CASE_VIEW
CASE_CREATE
CASE_UPDATE
CASE_APPROVE
CASE_REJECT
CASE_ASSIGN_ROOM
CASE_ACTIVATE
CASE_CHECKIN_PREOP
CASE_DELETE
CASE_CANCEL
CASE_PREFERENCE_CARD_LINK
VERIFY_SCAN
CHECKLIST_ATTEST
OR_DEBRIEF
OR_TIMEOUT
INVENTORY_READ
INVENTORY_CHECKIN
INVENTORY_MANAGE
USER_MANAGE
LOCATION_MANAGE
CATALOG_MANAGE
REPORTS_VIEW
SETTINGS_MANAGE
PHI_CLINICAL_ACCESS
PHI_WRITE_CLINICAL
PHI_PATIENT_SEARCH
PHI_BILLING_ACCESS
PHI_AUDIT_ACCESS
ORG_MANAGE
ORG_AFFILIATION_MANAGE
SURGERY_REQUEST_REVIEW
SURGERY_REQUEST_CONVERT
FINANCIAL_READINESS_VIEW
FINANCIAL_READINESS_EDIT
PLATFORM_ADMIN
PLATFORM_CONFIG_VIEW
PLATFORM_CONFIG_MANAGE

Defined: packages/domain/src/types.ts lines 132-174

================================================================================
D) ROLE â†’ CAPABILITY MAPPING
================================================================================

Source: packages/domain/src/types.ts lines 183-212 (ROLE_CAPABILITIES)

PLATFORM_ADMIN:
  PLATFORM_ADMIN
  PLATFORM_CONFIG_VIEW
  PLATFORM_CONFIG_MANAGE

ADMIN:
  USER_MANAGE
  LOCATION_MANAGE
  CATALOG_MANAGE
  INVENTORY_MANAGE
  REPORTS_VIEW
  SETTINGS_MANAGE
  CASE_VIEW
  CASE_CREATE
  CASE_UPDATE
  CASE_APPROVE
  CASE_REJECT
  CASE_ASSIGN_ROOM
  CASE_ACTIVATE
  CASE_CHECKIN_PREOP
  CASE_DELETE
  CASE_CANCEL
  CASE_PREFERENCE_CARD_LINK
  PHI_CLINICAL_ACCESS
  PHI_WRITE_CLINICAL
  PHI_PATIENT_SEARCH
  PHI_AUDIT_ACCESS
  ORG_MANAGE
  ORG_AFFILIATION_MANAGE
  SURGERY_REQUEST_REVIEW
  SURGERY_REQUEST_CONVERT
  FINANCIAL_READINESS_VIEW
  FINANCIAL_READINESS_EDIT

SCHEDULER:
  CASE_VIEW
  CASE_CREATE
  CASE_UPDATE
  CASE_APPROVE
  CASE_REJECT
  CASE_ASSIGN_ROOM
  CASE_ACTIVATE
  CASE_CHECKIN_PREOP
  CASE_CANCEL
  PHI_CLINICAL_ACCESS
  PHI_PATIENT_SEARCH
  SURGERY_REQUEST_REVIEW

INVENTORY_TECH:
  CASE_VIEW
  INVENTORY_READ
  INVENTORY_CHECKIN
  PHI_CLINICAL_ACCESS
  PHI_PATIENT_SEARCH

CIRCULATOR:
  CASE_VIEW
  CHECKLIST_ATTEST
  OR_DEBRIEF
  OR_TIMEOUT
  CASE_CHECKIN_PREOP
  PHI_CLINICAL_ACCESS
  PHI_PATIENT_SEARCH

SURGEON:
  CASE_VIEW
  CASE_CREATE
  CASE_UPDATE
  CASE_CANCEL
  CASE_PREFERENCE_CARD_LINK
  CHECKLIST_ATTEST
  PHI_CLINICAL_ACCESS
  PHI_PATIENT_SEARCH

SCRUB:
  CASE_VIEW
  VERIFY_SCAN
  CHECKLIST_ATTEST
  PHI_CLINICAL_ACCESS
  PHI_PATIENT_SEARCH

ANESTHESIA:
  CASE_VIEW
  CHECKLIST_ATTEST
  PHI_CLINICAL_ACCESS
  PHI_PATIENT_SEARCH

No duplication detected. Single canonical mapping in packages/domain/src/types.ts.

================================================================================
E) API ENFORCEMENT MATRIX (ROUTE-LEVEL)
================================================================================

Auth Routes (apps/api/src/routes/auth.routes.ts):
  POST /api/auth/login - No authentication required
  POST /api/auth/logout - fastify.authenticate
  GET /api/auth/me - fastify.authenticate

Platform Routes (apps/api/src/routes/platform.routes.ts):
  GET /api/platform/health - requirePlatformAdmin()
  GET /api/platform/facilities - requirePlatformAdmin()

Platform Config Routes (apps/api/src/routes/platform-config.routes.ts):
  Mounted at /api/platform/config
  All routes - requirePlatformAdmin() (inherited from parent or applied per-route)

Platform Facility View Routes (apps/api/src/routes/platform-facility-view.routes.ts):
  Mounted at /api/platform/facility-view
  All routes - requirePlatformAdmin() (inherited from parent or applied per-route)

Cases Routes (apps/api/src/routes/cases.routes.ts):
  GET /api/cases - fastify.authenticate, requirePhiAccess('PHI_CLINICAL')
  GET /api/cases/:caseId - fastify.authenticate, requirePhiAccess('PHI_CLINICAL', { evaluateCase: true })
  PATCH /api/cases/:caseId - requireCapabilities('CASE_UPDATE'), requirePhiAccess('PHI_CLINICAL', { evaluateCase: true })
  POST /api/cases/:caseId/approve - requireCapabilities('CASE_APPROVE'), requirePhiAccess('PHI_CLINICAL', { evaluateCase: true }), idempotent()
  POST /api/cases/:caseId/reject - requireCapabilities('CASE_REJECT'), requirePhiAccess('PHI_CLINICAL', { evaluateCase: true }), idempotent()
  PATCH /api/cases/:caseId/assign-room - requireCapabilities('CASE_ASSIGN_ROOM'), requirePhiAccess('PHI_CLINICAL', { evaluateCase: true }), idempotent()
  POST /api/cases - requireCapabilities('CASE_CREATE'), requirePhiAccess('PHI_CLINICAL')
  POST /api/cases/:caseId/activate - requireCapabilities('CASE_ACTIVATE'), requirePhiAccess('PHI_CLINICAL', { evaluateCase: true }), idempotent()
  POST /api/cases/:caseId/deactivate - requireCapabilities('CASE_ACTIVATE'), requirePhiAccess('PHI_CLINICAL', { evaluateCase: true }), idempotent()
  POST /api/cases/:caseId/cancel - requireCapabilities('CASE_CANCEL'), requirePhiAccess('PHI_CLINICAL', { evaluateCase: true }), idempotent()
  POST /api/cases/:caseId/check-in-preop - requireCapabilities('CASE_CHECKIN_PREOP'), requirePhiAccess('PHI_CLINICAL', { evaluateCase: true }), idempotent()
  GET /api/cases/:caseId/status-events - fastify.authenticate, requirePhiAccess('PHI_CLINICAL', { evaluateCase: true })
  POST /api/cases/:id/preference-card - requireCapabilities('CASE_PREFERENCE_CARD_LINK'), requirePhiAccess('PHI_CLINICAL', { evaluateCase: true, caseIdFrom: 'id' })
  PUT /api/cases/:id/requirements - requireCapabilities('CASE_VIEW'), requirePhiAccess('PHI_CLINICAL', { evaluateCase: true, caseIdFrom: 'id' })
  DELETE /api/cases/:id - requireCapabilities('CASE_DELETE'), requirePhiAccess('PHI_CLINICAL', { evaluateCase: true, caseIdFrom: 'id' })

Users Routes (apps/api/src/routes/users.routes.ts):
  GET /api/users - requireCapabilities('USER_MANAGE')
  GET /api/users/surgeons - fastify.authenticate
  GET /api/users/:id - requireCapabilities('USER_MANAGE')
  POST /api/users - requireCapabilities('USER_MANAGE')
  PATCH /api/users/:id - requireCapabilities('USER_MANAGE')
  POST /api/users/:id/deactivate - requireCapabilities('USER_MANAGE')
  POST /api/users/:id/activate - requireCapabilities('USER_MANAGE')

Locations Routes (apps/api/src/routes/locations.routes.ts):
  GET /api/locations - fastify.authenticate
  GET /api/locations/:id - fastify.authenticate
  POST /api/locations - requireCapabilities('LOCATION_MANAGE')
  PATCH /api/locations/:id - requireCapabilities('LOCATION_MANAGE')
  POST /api/locations/:id/deactivate - requireCapabilities('LOCATION_MANAGE')
  POST /api/locations/:id/activate - requireCapabilities('LOCATION_MANAGE')

Catalog Routes (apps/api/src/routes/catalog.routes.ts):
  GET /api/catalog - fastify.authenticate (inferred from pattern)
  GET /api/catalog/:id - fastify.authenticate (inferred from pattern)
  POST /api/catalog - requireCapabilities('CATALOG_MANAGE')
  PATCH /api/catalog/:id - requireCapabilities('CATALOG_MANAGE')
  POST /api/catalog/:id/deactivate - requireCapabilities('CATALOG_MANAGE')
  POST /api/catalog/:id/activate - requireCapabilities('CATALOG_MANAGE')
  POST /api/catalog/:id/cost - requireCapabilities('CATALOG_MANAGE')
  PATCH /api/catalog/:id/cost/:costId - requireCapabilities('CATALOG_MANAGE')
  DELETE /api/catalog/:id/cost/:costId - requireCapabilities('CATALOG_MANAGE')

Inventory Routes (apps/api/src/routes/inventory.routes.ts):
  Multiple routes with varying enforcement
  Common patterns:
    - requireCapabilities('INVENTORY_MANAGE')
    - requireCapabilities('INVENTORY_CHECKIN', 'INVENTORY_MANAGE')
    - requireCapabilities('CASE_VIEW')
    - requirePhiAccess('PHI_CLINICAL', { evaluateCase: true })

Checklists Routes (apps/api/src/routes/checklists.routes.ts):
  GET /api/checklists/templates - requireCapabilities('SETTINGS_MANAGE')
  POST /api/cases/:id/timeout - fastify.authenticate, requirePhiAccess('PHI_CLINICAL', { evaluateCase: true, caseIdFrom: 'id' })
  POST /api/cases/:id/debrief - fastify.authenticate, requirePhiAccess('PHI_CLINICAL', { evaluateCase: true, caseIdFrom: 'id' })
  PATCH /api/cases/:id/timeout/:instanceId - fastify.authenticate, requirePhiAccess('PHI_CLINICAL', { evaluateCase: true, caseIdFrom: 'id' })
  PATCH /api/cases/:id/debrief/:instanceId - fastify.authenticate, requirePhiAccess('PHI_CLINICAL', { evaluateCase: true, caseIdFrom: 'id' })
  POST /api/cases/:id/timeout/:instanceId/sign - fastify.authenticate, requirePhiAccess('PHI_CLINICAL', { evaluateCase: true, caseIdFrom: 'id' })
  POST /api/cases/:id/debrief/:instanceId/sign - fastify.authenticate, requirePhiAccess('PHI_CLINICAL', { evaluateCase: true, caseIdFrom: 'id' })

Reports Routes (apps/api/src/routes/reports.routes.ts):
  GET /api/reports - fastify.authenticate
  GET /api/reports/inventory-readiness - fastify.authenticate
  GET /api/reports/verification-activity - fastify.authenticate
  GET /api/reports/checklist-compliance - fastify.authenticate, requirePhiAccess('PHI_CLINICAL')
  GET /api/reports/case-summary - fastify.authenticate, requirePhiAccess('PHI_CLINICAL')
  GET /api/reports/vendor-concessions - fastify.authenticate, requirePhiAccess('PHI_BILLING')
  GET /api/reports/inventory-valuation - fastify.authenticate, requirePhiAccess('PHI_BILLING')
  GET /api/reports/loaner-exposure - fastify.authenticate, requirePhiAccess('PHI_BILLING')
  GET /api/reports/cancelled-cases - fastify.authenticate, requirePhiAccess('PHI_CLINICAL')
  GET /api/reports/case-timelines - fastify.authenticate, requirePhiAccess('PHI_CLINICAL')
  GET /api/reports/debrief-summary - fastify.authenticate, requirePhiAccess('PHI_CLINICAL')
  GET /api/reports/case-event-log - fastify.authenticate, requirePhiAccess('PHI_CLINICAL')

Admin Settings Routes (apps/api/src/routes/admin-settings.routes.ts):
  GET /api/admin-settings/timeout-debrief - requireCapabilities('SETTINGS_MANAGE')

General Settings Routes (apps/api/src/routes/general-settings.routes.ts):
  Multiple routes - requireCapabilities('SETTINGS_MANAGE')

Surgery Requests Routes (apps/api/src/routes/admin-surgery-requests.routes.ts):
  GET /api/admin-surgery-requests - requireCapabilities('SURGERY_REQUEST_REVIEW')
  GET /api/admin-surgery-requests/:id - requireCapabilities('SURGERY_REQUEST_REVIEW')
  POST /api/admin-surgery-requests/:id/return - requireCapabilities('SURGERY_REQUEST_REVIEW')
  POST /api/admin-surgery-requests/:id/accept - requireCapabilities('SURGERY_REQUEST_REVIEW')
  POST /api/admin-surgery-requests/:id/reject - requireCapabilities('SURGERY_REQUEST_REVIEW')
  POST /api/admin-surgery-requests/:id/withdraw - requireCapabilities('SURGERY_REQUEST_REVIEW')
  POST /api/admin-surgery-requests/:id/reopen - requireCapabilities('SURGERY_REQUEST_REVIEW')
  POST /api/admin-surgery-requests/:id/convert - requireCapabilities('SURGERY_REQUEST_CONVERT')

Financial Readiness Routes (apps/api/src/routes/financial-readiness.routes.ts):
  GET /api/financial-readiness - requireCapabilities('FINANCIAL_READINESS_VIEW')
  GET /api/financial-readiness/:requestId - requireCapabilities('FINANCIAL_READINESS_VIEW')
  POST /api/financial-readiness/:requestId/verify - requireCapabilities('FINANCIAL_READINESS_EDIT')
  POST /api/financial-readiness/:requestId/override - requireCapabilities('FINANCIAL_READINESS_EDIT')
  DELETE /api/financial-readiness/:requestId/override - requireCapabilities('FINANCIAL_READINESS_EDIT')

Catalog Images Routes (apps/api/src/routes/catalog-images.routes.ts):
  Multiple routes - fastify.authenticate, requireCapabilities('CATALOG_MANAGE')

Catalog Groups Routes (apps/api/src/routes/catalog-groups.routes.ts):
  Multiple routes - requireCapabilities('CATALOG_MANAGE')

Catalog Sets Routes (apps/api/src/routes/catalog-sets.routes.ts):
  Multiple routes - requireCapabilities('CATALOG_MANAGE')

Loaner Sets Routes (apps/api/src/routes/loaner-sets.routes.ts):
  Multiple routes - requireCapabilities('INVENTORY_MANAGE')

Preference Cards Routes (apps/api/src/routes/preference-cards.routes.ts):
  GET /api/preference-cards - fastify.authenticate (inferred)
  POST /api/preference-cards - requireCapabilities('CATALOG_MANAGE')
  PATCH /api/preference-cards/:id - requireCapabilities('CATALOG_MANAGE')
  POST /api/preference-cards/:id/deactivate - requireCapabilities('CATALOG_MANAGE')
  POST /api/preference-cards/:id/versions - requireCapabilities('CATALOG_MANAGE')
  DELETE /api/preference-cards/:id/versions/:versionId - requireCapabilities('CATALOG_MANAGE')

Vendors Routes (apps/api/src/routes/vendors.routes.ts):
  Patterns similar to other admin resources (inferred)

Case Dashboard Routes (apps/api/src/routes/case-dashboard.routes.ts):
  Multiple routes - fastify.authenticate, requirePhiAccess('PHI_CLINICAL', { evaluateCase: true })

Clinic Surgery Requests Routes (apps/api/src/routes/clinic-surgery-requests.routes.ts):
  All routes - requireClinicAuth (custom authentication for external clinic submissions)

AI Routes (apps/api/src/routes/ai.routes.ts):
  Routes - fastify.authenticate, requirePhiAccess('PHI_CLINICAL', { evaluateCase: true })

PHI Patient Routes (apps/api/src/routes/phi-patient.routes.ts):
  Inferred PHI access requirements

PHI Audit Routes (apps/api/src/routes/phi-audit.routes.ts):
  Inferred PHI_AUDIT_ACCESS requirements

Readiness Routes (apps/api/src/routes/readiness.routes.ts):
  Inferred authentication and PHI requirements

Schedule Routes (apps/api/src/routes/schedule.routes.ts):
  Inferred case management capabilities

Attention Routes (apps/api/src/routes/attention.routes.ts):
  Inferred authentication

Organization Routes (apps/api/src/routes/organization.routes.ts):
  Inferred ORG_MANAGE capability

Operations Health Routes (apps/api/src/routes/operations-health.routes.ts):
  Inferred REPORTS_VIEW or similar

Case Cards Routes (apps/api/src/routes/case-cards.routes.ts):
  Inferred CATALOG_MANAGE or CASE_VIEW

Settings Routes (apps/api/src/routes/settings.routes.ts):
  Inferred SETTINGS_MANAGE

================================================================================
F) WEB/UI ENFORCEMENT MATRIX (ROUTE/PAGE/COMPONENT-LEVEL)
================================================================================

Layout Guards:

apps/web/src/app/(app)/layout.tsx
  - Applies AuthGuard to all routes under /app
  - Redirects unauthenticated users to /login
  - No role or capability requirements
  - All authenticated users can access

apps/web/src/app/(app)/platform/layout.tsx
  - Client-side check: requires PLATFORM_ADMIN role
  - Shows "Access Denied" message if user lacks role
  - Does not redirect, shows error in place

apps/web/src/app/(app)/platform/facility-view/layout.tsx
  - Nested under platform layout
  - Inherits PLATFORM_ADMIN requirement

Page-Level Access (inferred from app/lib/access-control.ts FEATURES array):

/calendar
  - Feature: calendar
  - No role or capability requirements
  - All authenticated users

/cases
  - Feature: case-requests
  - No role or capability requirements
  - All authenticated users

/preference-cards
  - Feature: preference-cards
  - No role or capability requirements
  - All authenticated users

/pending-reviews
  - Feature: pending-reviews
  - No role or capability requirements
  - All authenticated users

/surgeon/my-checklists
  - Feature: surgeon-checklists
  - Required roles: SURGEON

/unassigned-cases
  - Feature: unassigned-cases
  - Required roles: ADMIN, SCHEDULER

/case/[caseId]
  - Feature: case-dashboard (contextual)
  - Required capabilities: CASE_VIEW

/case/[caseId]/verify
  - Feature: case-verify (contextual)
  - Required capabilities: VERIFY_SCAN

/or/debrief/[caseId]
  - Feature: or-debrief (contextual)
  - Required capabilities: OR_DEBRIEF

/or/timeout/[caseId]
  - Feature: or-timeout (contextual)
  - Required capabilities: OR_TIMEOUT

/admin/cases
  - Feature: admin-cases
  - Required roles: ADMIN, SCHEDULER

/admin/users
  - Feature: admin-users
  - Required roles: ADMIN
  - Required capabilities: USER_MANAGE

/admin/locations
  - Feature: admin-locations
  - Required roles: ADMIN
  - Required capabilities: LOCATION_MANAGE

/admin/catalog
  - Feature: admin-catalog
  - Required roles: ADMIN
  - Required capabilities: CATALOG_MANAGE

/admin/inventory
  - Feature: admin-inventory
  - Required roles: ADMIN
  - Required capabilities: INVENTORY_MANAGE

/admin/inventory/check-in
  - Feature: admin-inventory-checkin
  - Required roles: ADMIN
  - Required capabilities: INVENTORY_CHECKIN

/admin/reports
  - Feature: admin-reports
  - Required roles: ADMIN
  - Required capabilities: REPORTS_VIEW

/admin/phi-audit
  - Feature: admin-phi-audit
  - Required roles: ADMIN
  - Required capabilities: PHI_AUDIT_ACCESS

/admin/general-settings
  - Feature: admin-general-settings
  - Required roles: ADMIN
  - Required capabilities: SETTINGS_MANAGE

/admin/pending-reviews
  - Feature: admin-pending-reviews
  - Required roles: ADMIN

Other pages exist but have no explicit guard in FEATURES array:
  /dashboard
  /help
  /admin/vendors
  /admin/loaner-sets
  /admin/catalog/groups
  /admin/catalog/groups/[groupId]
  /admin/catalog/sets
  /admin/inventory/risk-queue
  /admin/inventory/missing
  /admin/inventory/missing-analytics
  /admin/inventory/missing-events
  /admin/inventory/open-missing-aging
  /admin/inventory/financial-ledger
  /admin/catalog/[catalogId]/cost-history
  /admin/surgery-requests
  /admin/surgery-requests/[id]
  /admin/financial-readiness
  /admin/financial-readiness/[requestId]
  /admin/general-settings/facility
  /admin/general-settings/surgeons
  /admin/general-settings/operating-rooms
  /admin/general-settings/case-dashboard
  /admin/devices
  /admin/devices/events
  /admin/operations-health
  /admin/print/*
  /case-cards
  /case/[caseId]/timeline
  /phi/patients
  /platform/config-audit
  /platform/auth-audit
  /platform/facility-view
  /platform/facility-view/operations-health
  /platform/facility-view/reports
  /platform/facility-view/print/*
  /readiness/calendar-summary

Note: Pages not in FEATURES array may still be accessible by URL if authenticated, but may not appear in navigation. AccessGuard component usage in individual pages not detected in this scan.

================================================================================
G) EFFECTIVE ACCESS SUMMARY (MATRIX BY ROLE)
================================================================================

PLATFORM_ADMIN:
  Capabilities: PLATFORM_ADMIN, PLATFORM_CONFIG_VIEW, PLATFORM_CONFIG_MANAGE
  Web pages accessible:
    /platform/* (all platform routes)
  API routes accessible:
    /api/platform/* (all platform routes)
  Tenant data access: NONE (no facilityId, cannot access tenant routes)
  Notes: No tenant capabilities. Cannot access /app routes requiring tenant context.

ADMIN:
  Capabilities: All tenant capabilities except PLATFORM_* and VERIFY_SCAN, OR_TIMEOUT
  Web pages accessible:
    All /app routes
    /admin/* (all admin routes)
    /case/[caseId] (case dashboard)
    /surgeon/my-checklists (if also SURGEON role)
    /unassigned-cases
  API routes accessible:
    All tenant API routes
  Notes: Broadest tenant access. Can manage users, settings, inventory, catalog, cases, reports, PHI.

SCHEDULER:
  Capabilities: CASE_VIEW, CASE_CREATE, CASE_UPDATE, CASE_APPROVE, CASE_REJECT, CASE_ASSIGN_ROOM, CASE_ACTIVATE, CASE_CHECKIN_PREOP, CASE_CANCEL, PHI_CLINICAL_ACCESS, PHI_PATIENT_SEARCH, SURGERY_REQUEST_REVIEW
  Web pages accessible:
    /calendar
    /cases
    /preference-cards
    /pending-reviews
    /unassigned-cases
    /admin/cases
    /case/[caseId]
  API routes accessible:
    /api/cases/* (most case operations)
    /api/admin-surgery-requests/* (review only, not convert)
    /api/users/surgeons (read surgeons)
    /api/locations (read)
    /api/catalog (read, inferred)
  Notes: Case scheduling and surgery request review. Cannot manage admin resources.

INVENTORY_TECH:
  Capabilities: CASE_VIEW, INVENTORY_READ, INVENTORY_CHECKIN, PHI_CLINICAL_ACCESS, PHI_PATIENT_SEARCH
  Web pages accessible:
    /calendar
    /cases
    /preference-cards
    /pending-reviews
    /case/[caseId]
    /admin/inventory/check-in (if INVENTORY_CHECKIN = INVENTORY_TECH granted access)
  API routes accessible:
    /api/cases (read)
    /api/inventory/* (check-in routes)
  Notes: Inventory operations. Cannot create or modify cases.

CIRCULATOR:
  Capabilities: CASE_VIEW, CHECKLIST_ATTEST, OR_DEBRIEF, OR_TIMEOUT, CASE_CHECKIN_PREOP, PHI_CLINICAL_ACCESS, PHI_PATIENT_SEARCH
  Web pages accessible:
    /calendar
    /cases
    /preference-cards
    /pending-reviews
    /case/[caseId]
    /or/timeout/[caseId]
    /or/debrief/[caseId]
  API routes accessible:
    /api/cases (read, check-in-preop)
    /api/cases/:id/timeout
    /api/cases/:id/debrief
  Notes: OR workflow operations. Timeout and debrief checklists.

SURGEON:
  Capabilities: CASE_VIEW, CASE_CREATE, CASE_UPDATE, CASE_CANCEL, CASE_PREFERENCE_CARD_LINK, CHECKLIST_ATTEST, PHI_CLINICAL_ACCESS, PHI_PATIENT_SEARCH
  Web pages accessible:
    /calendar
    /cases
    /preference-cards
    /pending-reviews
    /surgeon/my-checklists
    /case/[caseId]
  API routes accessible:
    /api/cases (create, update, cancel own cases)
    /api/cases/:id/preference-card
    /api/preference-cards (read)
  Notes: Can create and manage own cases. Cannot approve or schedule.

SCRUB:
  Capabilities: CASE_VIEW, VERIFY_SCAN, CHECKLIST_ATTEST, PHI_CLINICAL_ACCESS, PHI_PATIENT_SEARCH
  Web pages accessible:
    /calendar
    /cases
    /preference-cards
    /pending-reviews
    /case/[caseId]
    /case/[caseId]/verify
  API routes accessible:
    /api/cases (read)
    /api/inventory/* (verify scan)
  Notes: Readiness verification and attestation.

ANESTHESIA:
  Capabilities: CASE_VIEW, CHECKLIST_ATTEST, PHI_CLINICAL_ACCESS, PHI_PATIENT_SEARCH
  Web pages accessible:
    /calendar
    /cases
    /preference-cards
    /pending-reviews
    /case/[caseId]
  API routes accessible:
    /api/cases (read)
    /api/checklists/* (attestation)
  Notes: Case viewing and checklist attestation.

================================================================================
H) DIVERGENCES BETWEEN CLIENT AND SERVER ENFORCEMENT
================================================================================

1. UI feature definitions in apps/web/src/lib/access-control.ts do not cover all pages
   - Factual observation: FEATURES array contains 26 features
   - Total web pages found: 70+ page.tsx files
   - Pages not in FEATURES array remain accessible by URL if user is authenticated
   - Examples: /dashboard, /help, /admin/vendors, /admin/loaner-sets, /admin/devices

2. Client-side AccessGuard is advisory only
   - Implemented: apps/web/src/components/AccessGuard.tsx
   - Purpose: UX hiding of UI elements
   - Does not prevent API access
   - Server-side enforcement is authoritative

3. Platform admin layout uses client-side role check
   - Implemented: apps/web/src/app/(app)/platform/layout.tsx line 32
   - Shows error message in place, does not redirect
   - API routes under /api/platform/* enforce requirePlatformAdmin() at server
   - Client and server enforcement aligned for PLATFORM_ADMIN

4. PHI access enforcement uses separate plugin
   - Implemented: requirePhiAccess function in apps/api/src/plugins/phi-guard.js
   - Used in conjunction with capability checks
   - Examples: requireCapabilities('CASE_VIEW'), requirePhiAccess('PHI_CLINICAL', { evaluateCase: true })
   - PHI capabilities (PHI_CLINICAL_ACCESS, PHI_BILLING_ACCESS, PHI_AUDIT_ACCESS) exist in ROLE_CAPABILITIES
   - Relationship between requirePhiAccess and PHI_* capabilities: requirePhiAccess enforces purpose/context rules, capabilities gate which classification tiers user can access

5. Some routes combine multiple capability checks
   - Example: apps/api/src/routes/inventory.routes.ts line 820
     requireCapabilities('INVENTORY_CHECKIN', 'INVENTORY_MANAGE')
   - Uses OR logic (ANY of the listed capabilities)
   - Not AND logic (consistent with requireCapabilities implementation)

6. Case requirements route has owner-based authorization
   - Route: PUT /api/cases/:id/requirements (apps/api/src/routes/cases.routes.ts line 587)
   - Required capability: CASE_VIEW (line 588)
   - Additional authorization logic: Only assigned surgeon or ADMIN can modify (lines 598-610)
   - This is inline business logic, not declared in preHandler
   - UI shows the capability gate, but server has additional restrictions

7. Direct scheduling capability derivation
   - Route: POST /api/cases (apps/api/src/routes/cases.routes.ts line 334-343)
   - Required capability: CASE_CREATE
   - Additional inline check: Creating with status=SCHEDULED requires CASE_APPROVE capability
   - Inline derivation uses getUserRoles and deriveCapabilities (same as preHandler)
   - Capability model is used, but check happens in handler body, not preHandler

8. Tenant context requirement for tenant routes
   - Implemented: requireTenantContext() in apps/api/src/plugins/auth.ts lines 190-211
   - Purpose: Reject PLATFORM_ADMIN from accessing tenant routes
   - Not widely applied in current routes
   - Most tenant routes rely on facilityId from JWT payload
   - PLATFORM_ADMIN has facilityId=null, causes natural rejection in facility-scoped queries
   - Explicit requireTenantContext preHandler not detected in route files scanned

9. Clinic authentication uses separate mechanism
   - Route file: apps/api/src/routes/clinic-surgery-requests.routes.ts line 21
   - Uses: requireClinicAuth (not requireRoles or requireCapabilities)
   - Separate authentication scheme for external clinic submissions
   - Not part of role/capability model

10. Export purpose enforcement for reports
    - Implemented: enforceExportPurpose function in apps/api/src/routes/reports.routes.ts lines 153-166
    - Applied to CSV exports of PHI-containing reports
    - Checks purpose from request headers/context
    - Separate from capability checks
    - Used in conjunction with requirePhiAccess

11. Feature definitions are documentation/navigation, not enforcement
    - FEATURES array in apps/web/src/lib/access-control.ts
    - Used by: navigation menus, debug panel, feature discovery
    - Not used by: page layouts, actual access control (except via manual AccessGuard usage)
    - AccessGuard component exists but not detected in page files during scan

12. Multi-role users receive UNION of capabilities
    - Implemented: deriveCapabilities function (packages/domain/src/types.ts lines 217-225)
    - JWT contains roles array (JWT payload line 19 in auth.ts)
    - Access = union of all capabilities from all roles
    - Both client and server use same deriveCapabilities from @asc/domain
    - No divergence detected

END OF SNAPSHOT
