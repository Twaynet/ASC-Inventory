STATE MACHINE SNAPSHOT
Generated: 2026-02-14
Scope: All implemented state machines in ASC-Inventory codebase

================================================================================
A) STATE MACHINE INVENTORY
================================================================================

1. Surgical Case
   Status field: status (case_status enum)
   Active/lifecycle flags: is_active, is_cancelled
   Defining files:
   - apps/api/db/migrations/001_initial_schema.sql (line 22-28)
   - packages/domain/src/types.ts (line 227-238)

2. Inventory Item (Availability)
   Status field: availability_status (availability_status enum)
   Defining files:
   - apps/api/db/migrations/001_initial_schema.sql (line 51-57)
   - packages/domain/src/types.ts (line 274-281)

3. Inventory Item (Sterility)
   Status field: sterility_status (sterility_status enum)
   Defining files:
   - apps/api/db/migrations/001_initial_schema.sql (line 44-49)
   - packages/domain/src/types.ts (line 266-272)

4. Case Card
   Status field: status (case_card_status enum)
   Defining files:
   - apps/api/db/migrations/011_case_cards.sql (line 12-16)

5. Checklist Instance
   Status field: status (checklist_status enum)
   Defining files:
   - apps/api/db/migrations/004_timeout_debrief.sql (line 9)
   - packages/domain/src/types.ts (line 663-664)

6. Surgery Request
   Status field: status (surgery_request_status enum)
   Defining files:
   - apps/api/db/migrations/059_surgery_request.sql (line 10-17)
   - packages/domain/src/types.ts (line 306-314)

7. Surgery Request Checklist Instance
   Status field: status (surgery_request_checklist_status enum)
   Defining files:
   - apps/api/db/migrations/059_surgery_request.sql (line 29-32)
   - packages/domain/src/types.ts (line 330-331)

================================================================================
B) STATES
================================================================================

Surgical Case (case_status):
DRAFT - packages/domain/src/types.ts (line 228)
REQUESTED - packages/domain/src/types.ts (line 229)
SCHEDULED - packages/domain/src/types.ts (line 230)
IN_PREOP - packages/domain/src/types.ts (line 231)
READY - packages/domain/src/types.ts (line 232)
IN_PROGRESS - packages/domain/src/types.ts (line 233)
COMPLETED - packages/domain/src/types.ts (line 234)
CANCELLED - packages/domain/src/types.ts (line 235)
REJECTED - packages/domain/src/types.ts (line 236)

Inventory Item Availability (availability_status):
AVAILABLE - packages/domain/src/types.ts (line 275)
RESERVED - packages/domain/src/types.ts (line 276)
IN_USE - packages/domain/src/types.ts (line 277)
UNAVAILABLE - packages/domain/src/types.ts (line 278)
MISSING - packages/domain/src/types.ts (line 279)

Inventory Item Sterility (sterility_status):
STERILE - packages/domain/src/types.ts (line 267)
NON_STERILE - packages/domain/src/types.ts (line 268)
EXPIRED - packages/domain/src/types.ts (line 269)
UNKNOWN - packages/domain/src/types.ts (line 270)

Case Card (case_card_status):
DRAFT - apps/api/db/migrations/011_case_cards.sql (line 13)
ACTIVE - apps/api/db/migrations/011_case_cards.sql (line 14)
DEPRECATED - apps/api/db/migrations/011_case_cards.sql (line 15)

Checklist Instance (checklist_status):
NOT_STARTED - packages/domain/src/types.ts (line 663)
IN_PROGRESS - packages/domain/src/types.ts (line 663)
COMPLETED - packages/domain/src/types.ts (line 663)

Surgery Request (surgery_request_status):
SUBMITTED - packages/domain/src/types.ts (line 307)
RETURNED_TO_CLINIC - packages/domain/src/types.ts (line 308)
ACCEPTED - packages/domain/src/types.ts (line 309)
REJECTED - packages/domain/src/types.ts (line 310)
WITHDRAWN - packages/domain/src/types.ts (line 311)
CONVERTED - packages/domain/src/types.ts (line 312)

Surgery Request Checklist Instance (surgery_request_checklist_status):
PENDING - packages/domain/src/types.ts (line 330)
COMPLETE - packages/domain/src/types.ts (line 330)

================================================================================
C) TRANSITIONS
================================================================================

Surgical Case:

From: null (creation)
To: REQUESTED
Trigger: POST /cases (status not specified or surgeon creating)
File: apps/api/src/repositories/postgres/case.repository.ts (line 180-213)

From: null (creation)
To: SCHEDULED
Trigger: POST /cases (with status=SCHEDULED and CASE_APPROVE capability)
File: apps/api/src/routes/cases.routes.ts (line 333-342)
File: apps/api/src/repositories/postgres/case.repository.ts (line 182-183)

From: REQUESTED
To: SCHEDULED
Trigger: POST /cases/:caseId/approve
File: apps/api/src/routes/cases.routes.ts (line 199-224)
File: apps/api/src/repositories/postgres/case.repository.ts (line 330-359)

From: REQUESTED
To: REJECTED
Trigger: POST /cases/:caseId/reject
File: apps/api/src/routes/cases.routes.ts (line 227-242)
File: apps/api/src/repositories/postgres/case.repository.ts (line 362-388)

From: DRAFT
To: SCHEDULED
Trigger: POST /cases/:caseId/activate
File: apps/api/src/routes/cases.routes.ts (line 385-420)
File: apps/api/src/repositories/postgres/case.repository.ts (line 296-327)

From: any status (except DRAFT)
To: DRAFT
Trigger: POST /cases/:caseId/deactivate
File: apps/api/src/routes/cases.routes.ts (line 423-449)
File: apps/api/src/repositories/postgres/case.repository.ts (line 391-413)

From: SCHEDULED
To: IN_PREOP
Trigger: POST /cases/:caseId/check-in-preop
File: apps/api/src/routes/cases.routes.ts (line 479-502)
File: apps/api/src/repositories/postgres/case.repository.ts (line 450-482)

From: any status
To: IN_PROGRESS
Trigger: PATCH /cases/:caseId (with status=IN_PROGRESS, checklist gate enforced)
File: apps/api/src/routes/cases.routes.ts (line 167-172)
File: apps/api/src/repositories/postgres/case.repository.ts (line 216-293)

From: any status
To: COMPLETED
Trigger: PATCH /cases/:caseId (with status=COMPLETED, checklist gate enforced)
File: apps/api/src/routes/cases.routes.ts (line 174-178)
File: apps/api/src/repositories/postgres/case.repository.ts (line 216-293)

From: any status
To: CANCELLED
Trigger: POST /cases/:caseId/cancel
File: apps/api/src/routes/cases.routes.ts (line 452-476)
File: apps/api/src/repositories/postgres/case.repository.ts (line 416-447)

Inventory Item (Availability):

From: any
To: AVAILABLE
Trigger: POST /inventory/events (eventType=RECEIVED or RELEASED or ADJUSTED)
File: apps/api/src/routes/inventory.routes.ts (line 109-187)

From: any
To: RESERVED
Trigger: POST /inventory/events (eventType=RESERVED)
File: apps/api/src/routes/inventory.routes.ts (line 129-132)

From: any
To: UNAVAILABLE
Trigger: POST /inventory/events (eventType=CONSUMED)
File: apps/api/src/routes/inventory.routes.ts (line 140-144)

From: any
To: MISSING
Trigger: POST /inventory/events (eventType=ADJUSTED with [MARK_MISSING] note or adjustment.availabilityStatus=MISSING)
File: apps/api/src/routes/inventory.routes.ts (line 154-175)

Inventory Item (Sterility):

From: any
To: STERILE
Trigger: POST /inventory/events (eventType=RECEIVED with sterilityStatus)
File: apps/api/src/routes/inventory.routes.ts (line 149-152)

From: any
To: EXPIRED
Trigger: POST /inventory/events (eventType=EXPIRED)
File: apps/api/src/routes/inventory.routes.ts (line 146-147)

Checklist Instance:

From: NOT_STARTED
To: IN_PROGRESS
Trigger: First response submitted to checklist
File: UNKNOWN (inferred from status enum, no explicit transition code found)

From: IN_PROGRESS
To: COMPLETED
Trigger: All required items and signatures completed
File: UNKNOWN (inferred from status enum, no explicit transition code found)

Surgery Request:

From: null (creation)
To: SUBMITTED
Trigger: Clinic submission via API
File: apps/api/src/services/surgery-request.service.ts (line 176-225)

From: SUBMITTED
To: RETURNED_TO_CLINIC
Trigger: ASC returns request to clinic
File: packages/domain/src/types.ts (line 348) (transition map)

From: SUBMITTED
To: ACCEPTED
Trigger: ASC accepts request
File: packages/domain/src/types.ts (line 348) (transition map)

From: SUBMITTED
To: REJECTED
Trigger: ASC rejects request
File: packages/domain/src/types.ts (line 348) (transition map)

From: SUBMITTED
To: WITHDRAWN
Trigger: Clinic withdraws request
File: packages/domain/src/types.ts (line 348) (transition map)

From: RETURNED_TO_CLINIC
To: SUBMITTED
Trigger: Clinic resubmits
File: apps/api/src/services/surgery-request.service.ts (line 228-291)

From: RETURNED_TO_CLINIC
To: WITHDRAWN
Trigger: Clinic withdraws
File: packages/domain/src/types.ts (line 349) (transition map)

From: ACCEPTED
To: CONVERTED
Trigger: ASC converts to surgical_case
File: packages/domain/src/types.ts (line 350) (transition map)

From: ACCEPTED
To: WITHDRAWN
Trigger: Clinic withdraws
File: packages/domain/src/types.ts (line 350) (transition map)

Case Card:

From: DRAFT
To: ACTIVE
Trigger: UNKNOWN (no explicit transition code found)

From: ACTIVE
To: DEPRECATED
Trigger: UNKNOWN (no explicit transition code found)

Surgery Request Checklist Instance:

From: PENDING
To: COMPLETE
Trigger: UNKNOWN (no explicit transition code found)

================================================================================
D) ENFORCEMENT POINTS
================================================================================

Surgical Case:
- Repository layer: apps/api/src/repositories/postgres/case.repository.ts
  Enforces status transitions via dedicated methods (approve, reject, activate, etc.)
- Route layer: apps/api/src/routes/cases.routes.ts
  Enforces capability checks (CASE_APPROVE, CASE_REJECT, etc.)
  Enforces checklist gates for IN_PROGRESS and COMPLETED transitions (lines 167-178)
- Service layer: apps/api/src/services/checklists.service.ts
  Functions canStartCase() and canCompleteCase() validate checklist completion
- Audit layer: apps/api/src/services/case-status.service.ts
  Records all status transitions to surgical_case_status_event table

Inventory Item (Availability & Sterility):
- Route handler: apps/api/src/routes/inventory.routes.ts
  Function computeItemUpdate() maps event types to state changes (lines 109-187)
- No database constraints preventing invalid transitions
- State changes are append-only via inventory_event table (protected by triggers)

Checklist Instance:
- Database trigger protection: apps/api/db/migrations/004_timeout_debrief.sql
  case_checklist_response and case_checklist_signature are append-only (lines 113-142)
- No explicit status transition enforcement found in application code

Surgery Request:
- Service layer: apps/api/src/services/surgery-request.service.ts
  Function assertTransition() enforces SURGERY_REQUEST_TRANSITIONS map (lines 122-135)
- Transition map: packages/domain/src/types.ts (lines 347-354)
  Declarative state machine definition
- Database: surgery_request table has status column but no CHECK constraint
- Audit: All transitions recorded in surgery_request_audit_event (append-only)

Case Card:
- No enforcement points found in code
- Database has case_card_status enum but no transition enforcement

Surgery Request Checklist Instance:
- No enforcement points found in code
- Database has surgery_request_checklist_status enum but no transition enforcement

================================================================================
E) SIDE EFFECTS
================================================================================

Surgical Case Transitions:

Transition to SCHEDULED (via approve):
- Sets is_active = true
- Sets activated_at and activated_by_user_id
- Optionally sets room_id and estimated_duration_minutes
- Writes surgical_case_status_event record
File: apps/api/src/repositories/postgres/case.repository.ts (line 336-357)

Transition to SCHEDULED (via activate):
- Sets is_active = true
- Sets activated_at and activated_by_user_id
- Updates scheduled_date and scheduled_time
- Writes surgical_case_status_event record
File: apps/api/src/repositories/postgres/case.repository.ts (line 306-326)

Transition to REJECTED:
- Sets rejected_at and rejected_by_user_id
- Sets rejection_reason
- Writes surgical_case_status_event record
File: apps/api/src/repositories/postgres/case.repository.ts (line 368-386)

Transition to DRAFT (via deactivate):
- Sets is_active = false
- Writes surgical_case_status_event record
File: apps/api/src/repositories/postgres/case.repository.ts (line 396-411)

Transition to CANCELLED:
- Sets is_cancelled = true
- Sets cancelled_at and cancelled_by_user_id
- Appends cancellation reason to notes
- Writes surgical_case_status_event record
File: apps/api/src/repositories/postgres/case.repository.ts (line 426-445)

Transition to IN_PREOP:
- Sets preop_checked_in_at and preop_checked_in_by_user_id
- Writes surgical_case_status_event record
File: apps/api/src/repositories/postgres/case.repository.ts (line 464-480)

All status transitions:
- Trigger updated_at timestamp update
- Record event in surgical_case_status_event (append-only audit log)
File: apps/api/src/services/case-status.service.ts

Inventory Item Availability Transitions:

Transition to RESERVED:
- Sets reserved_for_case_id
- Writes inventory_event record (append-only)
File: apps/api/src/routes/inventory.routes.ts (line 129-132)

Transition to RELEASED:
- Clears reserved_for_case_id
- Writes inventory_event record (append-only)
File: apps/api/src/routes/inventory.routes.ts (line 134-138)

Transition to CONSUMED:
- Clears reserved_for_case_id
- Writes inventory_event record (append-only)
File: apps/api/src/routes/inventory.routes.ts (line 140-144)

All inventory state changes:
- Append-only inventory_event record (protected by database triggers)
- Database triggers prevent UPDATE/DELETE on inventory_event table
File: apps/api/db/migrations/001_initial_schema.sql (line 391-397)

Inventory Item Sterility Transitions:

Transition to VERIFIED:
- Sets last_verified_at and last_verified_by_user_id
- Writes inventory_event record (append-only)
File: apps/api/src/routes/inventory.routes.ts (line 119-123)

Surgery Request Transitions:

Transition to SUBMITTED (new request):
- Creates patient_ref record (upserted)
- Creates surgery_request_submission record (seq=1)
- Creates surgery_request_checklist_instance and responses (if provided)
- Writes surgery_request_audit_event (SUBMITTED)
File: apps/api/src/services/surgery-request.service.ts (line 176-225)

Transition to SUBMITTED (resubmit):
- Increments submission_seq
- Creates new surgery_request_submission record
- Creates new surgery_request_checklist_instance and responses (if provided)
- Writes surgery_request_audit_event (RESUBMITTED)
- Updates last_submitted_at timestamp
File: apps/api/src/services/surgery-request.service.ts (line 228-291)

Transition to CONVERTED:
- Creates surgical_case record
- Creates surgery_request_conversion link record (immutable)
- Writes surgery_request_audit_event (CONVERTED)
File: Inferred from schema (apps/api/db/migrations/059_surgery_request.sql line 252-270)

All surgery request transitions:
- Append-only audit trail in surgery_request_audit_event
- Database triggers prevent UPDATE/DELETE on audit tables
File: apps/api/db/migrations/059_surgery_request.sql (line 243-249)

Checklist Instance Transitions:

Transition to IN_PROGRESS:
- Sets started_at timestamp
File: Inferred from schema

Transition to COMPLETED:
- Sets completed_at timestamp
File: Inferred from schema

All checklist transitions:
- Append-only case_checklist_response and case_checklist_signature records
- Database triggers prevent modification of responses and signatures
File: apps/api/db/migrations/004_timeout_debrief.sql (line 113-142)

Case Card Transitions:
UNKNOWN (no transition code found)

================================================================================
F) INVALID OR BLOCKED TRANSITIONS
================================================================================

Surgical Case:

Blocked: SCHEDULED → IN_PROGRESS when timeout checklist incomplete
Enforcement: apps/api/src/routes/cases.routes.ts (line 167-172)
Implementation: apps/api/src/services/checklists.service.ts (canStartCase function)

Blocked: any → COMPLETED when debrief checklist incomplete
Enforcement: apps/api/src/routes/cases.routes.ts (line 174-178)
Implementation: apps/api/src/services/checklists.service.ts (canCompleteCase function)

Blocked: REQUESTED → SCHEDULED when case not in REQUESTED status
Enforcement: apps/api/src/repositories/postgres/case.repository.ts (line 347)
SQL WHERE clause: WHERE status = 'REQUESTED'

Blocked: REQUESTED → REJECTED when case not in REQUESTED status
Enforcement: apps/api/src/repositories/postgres/case.repository.ts (line 375)
SQL WHERE clause: WHERE status = 'REQUESTED'

Blocked: activate when case is already active
Enforcement: apps/api/src/routes/cases.routes.ts (line 406-408)

Blocked: activate when case is cancelled
Enforcement: apps/api/src/routes/cases.routes.ts (line 402-404)

Blocked: deactivate when case is already inactive
Enforcement: apps/api/src/routes/cases.routes.ts (line 435-437)

Blocked: deactivate when case is IN_PROGRESS or COMPLETED
Enforcement: apps/api/src/routes/cases.routes.ts (line 439-441)

Blocked: cancel when case is already cancelled
Enforcement: apps/api/src/routes/cases.routes.ts (line 466-468)

Blocked: check-in to preop when case not in SCHEDULED status
Enforcement: apps/api/src/repositories/postgres/case.repository.ts (line 460-462)
SQL WHERE clause: WHERE status = 'SCHEDULED'

Inventory Item:
NONE FOUND
All transitions are permitted via inventory events; no validation of state machine rules.

Surgery Request:

All invalid transitions blocked by assertTransition() function
Enforcement: apps/api/src/services/surgery-request.service.ts (line 122-135)
Transition map: packages/domain/src/types.ts (line 347-354)

Terminal states (no outbound transitions):
- REJECTED
- WITHDRAWN
- CONVERTED

Blocked transitions enforced by map:
- SUBMITTED cannot transition to CONVERTED (must go through ACCEPTED first)
- REJECTED cannot transition to any state (terminal)
- WITHDRAWN cannot transition to any state (terminal)
- CONVERTED cannot transition to any state (terminal)

Checklist Instance:
NONE FOUND
No explicit validation preventing invalid transitions.

Case Card:
NONE FOUND
No explicit validation preventing invalid transitions.

Surgery Request Checklist Instance:
NONE FOUND
No explicit validation preventing invalid transitions.

================================================================================
G) DIVERGENCES OR INCONSISTENCIES
================================================================================

1. Surgical Case Status Transitions
   - Multiple code paths can update case status:
     * Dedicated repository methods (approve, reject, activate, cancel, etc.)
     * Generic update() method accepts any status value
   - The generic update() method (apps/api/src/repositories/postgres/case.repository.ts line 216-293)
     does not enforce state machine rules; it allows any status transition
   - Route layer adds checklist gates for IN_PROGRESS and COMPLETED, but these are not
     enforced at the repository layer
   - Files: apps/api/src/routes/cases.routes.ts (line 167-178)
            apps/api/src/repositories/postgres/case.repository.ts (line 216-293)

2. Inventory Item State Management
   - No explicit state machine definition or transition map exists
   - Transitions are implicit in the computeItemUpdate() function
   - Different event types can result in the same state (e.g., RELEASED and ADJUSTED both
     can set AVAILABLE)
   - No validation prevents invalid transitions (e.g., MISSING → IN_USE without intermediate states)
   - File: apps/api/src/routes/inventory.routes.ts (line 109-187)

3. Checklist Instance Status
   - Enum defines NOT_STARTED, IN_PROGRESS, COMPLETED states
   - No explicit transition code found in application layer
   - Status field exists in database but no enforcement of valid transitions
   - Files: apps/api/db/migrations/004_timeout_debrief.sql (line 77-96)
            packages/domain/src/types.ts (line 663-664)

4. Case Card Status
   - Enum defines DRAFT, ACTIVE, DEPRECATED states
   - No transition enforcement found in code
   - Constraint "unique_active_card" suggests only one ACTIVE card per surgeon+procedure+facility
     but no enforcement of transitions to/from ACTIVE
   - Files: apps/api/db/migrations/011_case_cards.sql (line 12-56)

5. Surgery Request Status
   - Well-defined state machine with SURGERY_REQUEST_TRANSITIONS map
   - assertTransition() function enforces valid transitions in service layer
   - However, no database CHECK constraint enforces the state machine at the database level
   - Inconsistency: transition enforcement only exists in application code, not at schema level
   - Files: packages/domain/src/types.ts (line 347-354)
            apps/api/src/services/surgery-request.service.ts (line 122-135)
            apps/api/db/migrations/059_surgery_request.sql (line 99-115)

6. Audit Event Immutability
   - inventory_event, attestation, device_event, case_checklist_response,
     case_checklist_signature, surgery_request_audit_event are all append-only
   - Protected by database triggers that prevent UPDATE/DELETE
   - surgical_case_status_event exists and is append-only
   - Inconsistency: case_card_edit_log is append-only but case_card table allows updates
   - Files: apps/api/db/migrations/001_initial_schema.sql (line 382-416)
            apps/api/db/migrations/004_timeout_debrief.sql (line 113-142)
            apps/api/db/migrations/011_case_cards.sql (line 156-162)
            apps/api/db/migrations/059_surgery_request.sql (line 144-149, 213-219, 243-249, 264-270)

7. Status Event Recording
   - surgical_case transitions consistently record events via recordStatusEvent()
   - inventory_item state changes recorded in inventory_event (append-only)
   - surgery_request transitions recorded in surgery_request_audit_event (append-only)
   - checklist_instance status changes are NOT recorded in any audit log
   - case_card status changes are NOT recorded in case_card_edit_log (only content edits logged)
   - Inconsistency: Not all state machines have equivalent audit trails
   - Files: apps/api/src/services/case-status.service.ts
            apps/api/db/migrations/011_case_cards.sql (line 100-127)

8. Reserved Case Items
   - Inventory items can be reserved for a case via reserved_for_case_id
   - Transition to RESERVED sets this field, RELEASED clears it
   - However, no enforcement prevents manual UPDATE of reserved_for_case_id outside the
     inventory event system
   - Inconsistency: State and foreign key can be modified independently of event log
   - File: apps/api/src/routes/inventory.routes.ts (line 129-138)

9. ReadinessState (not a status field, computed value)
   - ReadinessState enum (GREEN, ORANGE, RED) exists in types.ts
   - This is NOT a state machine but a computed value based on case requirements and inventory
   - No transitions tracked, no status field in database
   - Stored in case_readiness_cache table as materialized/computed state
   - File: packages/domain/src/types.ts (line 240-245)

10. Surgery Request Checklist Status
    - Enum defines PENDING, COMPLETE states
    - No explicit transition enforcement or audit trail found
    - Inconsistency with main surgery_request state machine which has full audit
    - Files: apps/api/db/migrations/059_surgery_request.sql (line 174-192)
             packages/domain/src/types.ts (line 330-331)

END OF SNAPSHOT
