SNAPSHOT OF OPERATIONAL WORKFLOWS END-TO-END
Generated: 2026-02-14
Source: Implemented code and committed artifacts only

================================================================================
A) CASE LIFECYCLE
================================================================================

Step: CREATE
Routes involved:
- Web: /components/CreateCaseModal.tsx
- Web: /components/ScheduleCaseModal.tsx
- API: POST /cases (contract route)
Key components:
- CreateCaseModal component (lines 1-233)
- ScheduleCaseModal component (lines 1-229)
- cases.routes.ts handler (lines 290-383)
Data reads and writes:
- API calls: createCase(token, caseData)
- Database tables touched:
  - SELECT from app_user (validate surgeon exists, role='SURGEON')
  - SELECT from preference_card (if preferenceCardId provided)
  - SELECT from organization (resolve primaryOrganizationId)
  - INSERT into surgical_case
  - If preference card version set: copyRequirementsFromVersion(newCase.id, preferenceCardVersionId)
Gating and role restrictions:
- Role: Any authenticated user
- Capability: CASE_CREATE
- PHI Access: PHI_CLINICAL
- Enforcement location: requireCapabilities middleware, requirePhiAccess middleware (cases.routes.ts line 292)
- Note: Creating directly in SCHEDULED status requires CASE_APPROVE capability (cases.routes.ts lines 335-343)

Step: SCHEDULE
Routes involved:
- API: POST /cases/:caseId/approve (contract route)
- API: PATCH /cases/:caseId (contract route, status update)
- API: PATCH /cases/:caseId/assign-room (contract route)
Key components:
- cases.routes.ts approve handler (lines 199-225)
- cases.routes.ts update handler (lines 135-197)
- cases.routes.ts assignRoom handler (lines 245-288)
Data reads and writes:
- API calls: Approve, update, or assign room
- Database tables touched:
  - SELECT from surgical_case (getStatus)
  - UPDATE surgical_case (set scheduledDate, scheduledTime, roomId, sortOrder, estimatedDurationMinutes, status='SCHEDULED')
  - SELECT from room (validate roomId if provided)
Gating and role restrictions:
- Approve: Capability CASE_APPROVE, PHI_CLINICAL access
- Update schedule on active cases: Capability CASE_ASSIGN_ROOM
- Assign room: Capability CASE_ASSIGN_ROOM, PHI_CLINICAL access
- Enforcement location: requireCapabilities middleware, requirePhiAccess middleware (cases.routes.ts lines 200, 137, 247)

Step: DASHBOARD
Routes involved:
- Web: /app/(app)/case/[caseId]/page.tsx
- Web: /components/CaseDashboardModal/CaseDashboardModal.tsx
- Web: /components/CaseDashboardModal/CaseDashboardContent.tsx
- API: GET /case-dashboard/:caseId
Key components:
- CaseDashboardModal component
- case-dashboard.routes.ts GET handler (lines 114-358)
Data reads and writes:
- API calls: getCaseDashboard(caseId)
- Database tables touched:
  - SELECT from surgical_case (with joins to facility, app_user, room)
  - SELECT from attestation (get latest attestation info)
  - SELECT from case_card_version (if case_card_version_id set)
  - SELECT from case_anesthesia_plan
  - SELECT from case_card_link_event (get current case card link)
  - SELECT from case_override (get active overrides)
  - SELECT from case_readiness_cache (get readiness state and missing items)
Gating and role restrictions:
- Role: Any authenticated user
- Capability: None (authenticated only)
- PHI Access: PHI_CLINICAL with evaluateCase=true
- Enforcement location: fastify.authenticate, requirePhiAccess middleware (case-dashboard.routes.ts line 115)

Step: VERIFY
Routes involved:
- Web: UNKNOWN (C:\Users\missp\source\repos\ASC-Inventory\apps\web\src\app\(app)\case\[caseId]\verify exists as directory with page.tsx)
- API: UNKNOWN (no dedicated verify route found in case-dashboard.routes.ts or cases.routes.ts)
Key components:
- UNKNOWN (verify page.tsx not read)
Data reads and writes:
- UNKNOWN
Gating and role restrictions:
- UNKNOWN

Step: TIMEOUT
Routes involved:
- Web: /components/Checklists/TimeoutModal.tsx
- API: GET /checklists/:caseId (inferred)
- API: POST /checklists/start (inferred)
- API: POST /checklists/respond (inferred)
- API: POST /checklists/sign (inferred)
- API: POST /checklists/complete (inferred)
Key components:
- TimeoutModal component (lines 1-100+)
Data reads and writes:
- API calls: getCaseChecklists, startChecklist, respondToChecklist, signChecklist, completeChecklist
- Database tables touched:
  - UNKNOWN (checklists.routes.ts not read in detail)
Gating and role restrictions:
- UNKNOWN (checklists.routes.ts not analyzed)
- Note: cases.routes.ts lines 168-172 show gate check: canStartCase(caseId, facilityId) must pass before status='IN_PROGRESS'

Step: DEBRIEF
Routes involved:
- Web: /components/Checklists/DebriefModal.tsx
- API: GET /checklists/:caseId (inferred)
- API: POST /checklists/start (inferred)
- API: POST /checklists/respond (inferred)
- API: POST /checklists/sign (inferred)
- API: POST /checklists/complete (inferred)
Key components:
- DebriefModal component (lines 1-100+)
Data reads and writes:
- API calls: getCaseChecklists, startChecklist, respondToChecklist, signChecklist, completeChecklist, getCaseDashboard, submitCaseCardFeedback
- Database tables touched:
  - UNKNOWN (checklists.routes.ts not read in detail)
Gating and role restrictions:
- UNKNOWN (checklists.routes.ts not analyzed)
- Note: cases.routes.ts lines 174-178 show gate check: canCompleteCase(caseId, facilityId) must pass before status='COMPLETED'

Step: COMPLETE
Routes involved:
- API: PATCH /cases/:caseId (contract route, status update to COMPLETED)
Key components:
- cases.routes.ts update handler (lines 135-197)
Data reads and writes:
- API calls: updateCase with status='COMPLETED'
- Database tables touched:
  - SELECT from surgical_case (getStatus)
  - UPDATE surgical_case (set status='COMPLETED')
Gating and role restrictions:
- Role: Any authenticated user
- Capability: CASE_UPDATE
- PHI Access: PHI_CLINICAL with evaluateCase=true
- Enforcement location: requireCapabilities middleware, requirePhiAccess middleware (cases.routes.ts line 137)
- Gate check: canCompleteCase(caseId, facilityId) enforced (cases.routes.ts lines 174-178)

================================================================================
B) INVENTORY LIFECYCLE
================================================================================

Step: CATALOG
Routes involved:
- Web: /app/(app)/admin/catalog/page.tsx
- Web: /app/(app)/admin/catalog/[catalogId]/cost-history/page.tsx
- API: GET /catalog (contract route)
- API: GET /catalog/:catalogId (contract route)
- API: POST /catalog (contract route)
Key components:
- catalog.routes.ts list handler (lines 48-115)
- catalog.routes.ts get handler (lines 117-168)
- catalog.routes.ts create handler (lines 170-200+)
Data reads and writes:
- API calls: getCatalogItems, getCatalogItem, createCatalogItem
- Database tables touched:
  - SELECT from item_catalog (with aggregates for inventory_count, image_count, identifier_count)
  - SELECT from item_catalog (single item)
  - INSERT into item_catalog
Gating and role restrictions:
- List/Get: Any authenticated user
- Create: Capability CATALOG_MANAGE
- Enforcement location: fastify.authenticate (list/get), requireCapabilities middleware (create, catalog.routes.ts line 172)

Step: CHECK-IN
Routes involved:
- Web: /app/(app)/admin/inventory/check-in/page.tsx
- API: POST /inventory/events (inferred from inventory.routes.ts)
- API: POST /inventory/items (inferred from inventory.routes.ts)
Key components:
- InventoryCheckInPage component (lines 1-100+)
- inventory.routes.ts (lines 1-200)
Data reads and writes:
- API calls: createInventoryEvent, createInventoryItem, getCatalogItems, getLocations, getCase (if caseId present)
- Database tables touched:
  - INSERT into inventory_event
  - INSERT into inventory_item (if new item)
  - UPDATE inventory_item (based on event type)
Gating and role restrictions:
- UNKNOWN (inventory.routes.ts handlers not read in detail)
- UI component: hasCapability check in component (inferred from useAccessControl usage line 77)

Step: LOCATION ASSIGNMENT
Routes involved:
- Web: /app/(app)/admin/inventory/check-in/page.tsx (mode='location_change')
- API: POST /inventory/events with eventType='LOCATION_CHANGED' (inferred)
Key components:
- InventoryCheckInPage component (lines 1-100+)
- inventory.routes.ts computeItemUpdate function (lines 108-188, case 'LOCATION_CHANGED' at line 125)
Data reads and writes:
- API calls: createInventoryEvent with eventType='LOCATION_CHANGED'
- Database tables touched:
  - INSERT into inventory_event
  - UPDATE inventory_item (set locationId based on event)
Gating and role restrictions:
- UNKNOWN (inventory.routes.ts handlers not read in detail)

Step: USE
Routes involved:
- API: POST /inventory/events with eventType='RESERVED' or 'CONSUMED' (inferred)
Key components:
- inventory.routes.ts computeItemUpdate function (lines 108-188)
  - Case 'RESERVED' at lines 128-132: sets availabilityStatus='RESERVED', reservedForCaseId=caseId
  - Case 'CONSUMED' at lines 140-144: sets availabilityStatus='UNAVAILABLE', reservedForCaseId=null
Data reads and writes:
- API calls: createInventoryEvent with eventType='RESERVED' or 'CONSUMED'
- Database tables touched:
  - INSERT into inventory_event
  - UPDATE inventory_item (set availabilityStatus, reservedForCaseId)
Gating and role restrictions:
- UNKNOWN (inventory.routes.ts handlers not read in detail)

Step: RECONCILIATION
Routes involved:
- Web: /app/(app)/admin/inventory/missing/page.tsx
- Web: /app/(app)/admin/inventory/missing-analytics/page.tsx
- Web: /app/(app)/admin/inventory/missing-events/page.tsx
- Web: /app/(app)/admin/inventory/open-missing-aging/page.tsx
- API: UNKNOWN (routes not read in detail)
Key components:
- UNKNOWN (pages and API routes not read)
Data reads and writes:
- UNKNOWN
Gating and role restrictions:
- UNKNOWN

================================================================================
C) CASE CARDS LIFECYCLE
================================================================================

Step: CREATE
Routes involved:
- Web: /app/components/PreferenceCardDialog.tsx
- API: POST /case-cards
Key components:
- PreferenceCardDialog component
- case-cards.routes.ts POST handler (lines 451-573)
Data reads and writes:
- API calls: createCaseCard
- Database tables touched:
  - SELECT from app_user (verify surgeon exists, role='SURGEON')
  - SELECT from case_card (check duplicate procedure name for surgeon)
  - INSERT into case_card (status='DRAFT', version='1.0.0')
  - INSERT into case_card_version (initial version with sections)
  - UPDATE case_card (set current_version_id)
  - INSERT into case_card_edit_log (log creation)
Gating and role restrictions:
- Role: ADMIN, INVENTORY_TECH, CIRCULATOR, SCRUB, SURGEON (SCHEDULER excluded)
- Capability: None (role-based only)
- Enforcement location: isRoleAllowed check in handler (case-cards.routes.ts lines 459-461)

Step: EDIT
Routes involved:
- API: PUT /case-cards/:id
- API: PATCH /case-cards/:caseCardId/versions/:versionId/components
- API: PATCH /case-cards/:caseCardId/versions/:versionId/overrides
Key components:
- case-cards.routes.ts PUT handler (lines 583-599+)
- case-cards.routes.ts PATCH handlers (grep results lines 1626, 1685)
Data reads and writes:
- API calls: updateCaseCard, patchComponents, patchOverrides
- Database tables touched:
  - SELECT from case_card (verify exists, check status, check lock)
  - INSERT into case_card_version (new version on edit)
  - UPDATE case_card (set current_version_id, increment version numbers)
  - INSERT into case_card_edit_log (log edit)
Gating and role restrictions:
- Role: ADMIN, INVENTORY_TECH, CIRCULATOR, SCRUB, SURGEON (SCHEDULER excluded)
- Lock requirement: Must hold lock or lock must be expired
- Read-only statuses: DELETED, DEPRECATED
- Enforcement location: isRoleAllowed check, lock check, status check in handler (case-cards.routes.ts lines 592-594, 597, 620-625)

Step: VERSION
Routes involved:
- API: GET /case-cards/:id/versions
- API: POST /case-cards/:id/revert/:versionId
Key components:
- case-cards.routes.ts GET versions handler (lines 410-444)
- case-cards.routes.ts POST revert handler (grep result line 1217)
Data reads and writes:
- API calls: getCaseCardVersions, revertCaseCardVersion
- Database tables touched:
  - SELECT from case_card_version (get all versions for card)
  - INSERT into case_card_version (create new version from reverted content)
  - UPDATE case_card (set current_version_id)
  - INSERT into case_card_edit_log (log revert action)
Gating and role restrictions:
- Get versions: Any authenticated user
- Revert: Same as edit restrictions (role-based, lock required, no DELETED/DEPRECATED)
- Enforcement location: fastify.authenticate (get versions line 411), handler checks for revert

Step: STATUS
Routes involved:
- API: POST /case-cards/:id/activate
- API: POST /case-cards/:id/deprecate
- API: POST /case-cards/:id/delete
Key components:
- case-cards.routes.ts POST activate handler (grep result line 755)
- case-cards.routes.ts POST deprecate handler (grep result line 803)
- case-cards.routes.ts POST delete handler (grep result line 872)
Data reads and writes:
- API calls: activateCaseCard, deprecateCaseCard, deleteCaseCard
- Database tables touched:
  - UPDATE case_card (set status to ACTIVE, DEPRECATED, or DELETED)
  - INSERT into case_card_edit_log (log status change)
  - For delete: UPDATE case_card (set deleted_at, deleted_by_user_id, delete_reason)
Gating and role restrictions:
- Activate: UNKNOWN (handler not read in detail)
- Deprecate: Only OWNER-SURGEON or ADMIN (per governance doc comment line 17)
- Delete: Only OWNER-SURGEON (per governance doc comment line 18)
- Enforcement location: Handler logic (not read in detail)

Step: LINK TO CASE
Routes involved:
- API: PUT /case-dashboard/:caseId/link-case-card
- API: POST /case-dashboard/:caseId/case-card-unlink
- API: GET /case-dashboard/:caseId/case-card-link
Key components:
- case-dashboard.routes.ts PUT link handler (lines 551-721)
- case-dashboard.routes.ts POST unlink handler (lines 727-774)
- case-dashboard.routes.ts GET link handler (lines 780-848)
Data reads and writes:
- API calls: linkCaseCard, unlinkCaseCard, getCaseCardLink
- Database tables touched:
  - SELECT from surgical_case (verify exists)
  - SELECT from case_card (resolve ACTIVE version if caseCardId provided)
  - UPDATE surgical_case (set case_card_version_id)
  - INSERT into case_card_link_event (write snapshot-based link/relink/unlink event)
  - INSERT into case_event_log (log action)
Gating and role restrictions:
- Role: Any authenticated user
- Capability: None (authenticated only)
- PHI Access: PHI_CLINICAL with evaluateCase=true
- Enforcement location: fastify.authenticate, requirePhiAccess middleware (case-dashboard.routes.ts lines 552, 728, 781)

Step: PRINT
Routes involved:
- Web: /components/CaseDashboardModal/CaseDashboardPrintView.tsx
- API: GET /case-cards/:id (to retrieve printable content)
Key components:
- CaseDashboardPrintView component
- case-cards.routes.ts GET handler (lines 257-360)
Data reads and writes:
- API calls: getCaseCard
- Database tables touched:
  - SELECT from case_card (with joins to app_user for surgeon and creator)
  - SELECT from case_card_version (get current version sections)
Gating and role restrictions:
- Role: Any authenticated user
- Capability: None (authenticated only)
- Enforcement location: fastify.authenticate (case-cards.routes.ts line 258)

Step: FEEDBACK
Routes involved:
- API: POST /case-cards/:id/feedback
- API: POST /case-cards/:id/feedback/:feedbackId/review
Key components:
- case-cards.routes.ts POST feedback handler (grep result line 1391)
- case-cards.routes.ts POST review handler (grep result line 1565)
Data reads and writes:
- API calls: submitCaseCardFeedback, reviewCaseCardFeedback
- Database tables touched:
  - INSERT into case_card_feedback (submit feedback)
  - UPDATE case_card_feedback (mark as reviewed)
Gating and role restrictions:
- UNKNOWN (handlers not read in detail)

Step: REVIEW
Routes involved:
- API: POST /case-cards/:id/feedback/:feedbackId/review
- Web: UNKNOWN (no dedicated review UI component found)
Key components:
- case-cards.routes.ts POST review handler (grep result line 1565)
Data reads and writes:
- API calls: reviewCaseCardFeedback
- Database tables touched:
  - UPDATE case_card_feedback (set reviewed_at, reviewed_by_user_id, admin_notes)
Gating and role restrictions:
- UNKNOWN (handler not read in detail)

================================================================================
END OF SNAPSHOT
================================================================================
