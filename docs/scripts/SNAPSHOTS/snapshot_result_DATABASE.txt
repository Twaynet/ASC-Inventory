DATABASE SNAPSHOT
Generated: 2026-02-14
Repository: ASC-Inventory
Snapshot Type: READ-ONLY AUDIT REPORT

================================================================================
1. DATABASE TECHNOLOGY IN USE
================================================================================

Engine/Vendor:
PostgreSQL

Client/Driver:
pg (node-postgres)
Version constraint: ^8.11.0
Package location: apps/api/package.json (line 29)

Where Configured:
apps/api/src/db/index.ts (lines 8-21)
Environment variables: DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD, DB_SSL
Default values: localhost:5432, database=asc_inventory, user=postgres
SSL enabled when DB_SSL=true (required for Neon, off for local dev)
Connection pool: max=20, idleTimeout=30s, connectionTimeout=2s

Migration System:
Custom migration runner at apps/api/db/migrate.ts
Migrations stored in apps/api/db/migrations/*.sql
Executed sequentially by filename sort order
No ORM - raw SQL migrations

Seed System:
apps/api/db/seed.ts
Two-phase seeding:
  Phase 1: Platform bootstrap (idempotent, always runs)
  Phase 2: Demo/tenant data (runs once, or with --reset flag)

================================================================================
2. SCHEMA DEFINITIONS
================================================================================

TABLES (61 total across all migrations):

facility
  id UUID PRIMARY KEY
  name VARCHAR(255) NOT NULL
  facility_key TEXT UNIQUE NOT NULL
  timezone VARCHAR(50) NOT NULL DEFAULT 'America/New_York'
  address TEXT
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: None listed beyond PK and UNIQUE
  Foreign Keys: None

app_user
  id UUID PRIMARY KEY
  facility_id UUID REFERENCES facility(id) (nullable for PLATFORM_ADMIN)
  username VARCHAR(100) NOT NULL
  email VARCHAR(255)
  name VARCHAR(255) NOT NULL
  role user_role NOT NULL (DEPRECATED - kept for backward compat)
  roles user_role[] NOT NULL (canonical authorization column, CHECK constraint >= 1 element)
  password_hash VARCHAR(255) NOT NULL
  active BOOLEAN NOT NULL DEFAULT true
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_user_facility, idx_user_role, idx_user_roles (GIN)
  Unique Constraints: (facility_id, username), facility_id UNIQUE WHERE NULL (for PLATFORM_ADMIN)
  Foreign Keys: facility_id -> facility(id)

location
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  name VARCHAR(255) NOT NULL
  description TEXT
  parent_location_id UUID REFERENCES location(id)
  active BOOLEAN NOT NULL DEFAULT true
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_location_facility, idx_location_parent
  Foreign Keys: facility_id -> facility(id), parent_location_id -> location(id)

item_catalog
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  name VARCHAR(255) NOT NULL
  description TEXT
  category item_category NOT NULL
  manufacturer VARCHAR(255)
  catalog_number VARCHAR(255)
  requires_sterility BOOLEAN NOT NULL DEFAULT true
  is_loaner BOOLEAN NOT NULL DEFAULT false
  is_container BOOLEAN NOT NULL DEFAULT false
  active BOOLEAN NOT NULL DEFAULT true
  requires_lot_tracking BOOLEAN NOT NULL DEFAULT false
  requires_serial_tracking BOOLEAN NOT NULL DEFAULT false
  requires_expiration_tracking BOOLEAN NOT NULL DEFAULT false
  criticality criticality NOT NULL DEFAULT 'ROUTINE'
  readiness_required BOOLEAN NOT NULL DEFAULT true
  expiration_warning_days INT
  substitutable BOOLEAN NOT NULL DEFAULT false
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_catalog_facility, idx_catalog_category, idx_catalog_active
  Foreign Keys: facility_id -> facility(id)

inventory_item
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  catalog_id UUID NOT NULL REFERENCES item_catalog(id)
  serial_number VARCHAR(255)
  lot_number VARCHAR(255)
  barcode VARCHAR(255)
  barcode_gtin VARCHAR(14)
  barcode_parsed_lot VARCHAR(255)
  barcode_parsed_serial VARCHAR(255)
  barcode_parsed_expiration DATE
  barcode_classification TEXT
  location_id UUID REFERENCES location(id)
  sterility_status sterility_status NOT NULL DEFAULT 'UNKNOWN'
  sterility_expires_at TIMESTAMPTZ
  availability_status availability_status NOT NULL DEFAULT 'AVAILABLE'
  reserved_for_case_id UUID REFERENCES surgical_case(id)
  last_verified_at TIMESTAMPTZ
  last_verified_by_user_id UUID REFERENCES app_user(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_inventory_facility, idx_inventory_catalog, idx_inventory_barcode, idx_inventory_location, idx_inventory_availability, idx_inventory_sterility, idx_inventory_readiness
  Foreign Keys: facility_id -> facility(id), catalog_id -> item_catalog(id), location_id -> location(id), reserved_for_case_id -> surgical_case(id), last_verified_by_user_id -> app_user(id)

preference_card
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  surgeon_id UUID NOT NULL REFERENCES app_user(id)
  procedure_name VARCHAR(255) NOT NULL
  description TEXT
  active BOOLEAN NOT NULL DEFAULT true
  current_version_id UUID REFERENCES preference_card_version(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_pref_card_facility, idx_pref_card_surgeon
  Foreign Keys: facility_id -> facility(id), surgeon_id -> app_user(id), current_version_id -> preference_card_version(id)

preference_card_version
  id UUID PRIMARY KEY
  preference_card_id UUID NOT NULL REFERENCES preference_card(id)
  version_number INT NOT NULL
  items JSONB NOT NULL (Array of {catalogId, quantity, notes})
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  created_by_user_id UUID NOT NULL REFERENCES app_user(id)
  Unique Constraints: (preference_card_id, version_number)
  Indexes: idx_pref_version_card
  Foreign Keys: preference_card_id -> preference_card(id), created_by_user_id -> app_user(id)

surgical_case
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  case_number VARCHAR(50) UNIQUE NOT NULL (generated by generate_case_number function)
  scheduled_date DATE (nullable until activation)
  scheduled_time TIME
  requested_date DATE
  requested_time TIME
  surgeon_id UUID NOT NULL REFERENCES app_user(id)
  procedure_name VARCHAR(255) NOT NULL
  preference_card_version_id UUID REFERENCES preference_card_version(id)
  status case_status NOT NULL DEFAULT 'DRAFT'
  notes TEXT
  is_active BOOLEAN NOT NULL DEFAULT false
  activated_at TIMESTAMPTZ
  activated_by_user_id UUID REFERENCES app_user(id)
  is_cancelled BOOLEAN NOT NULL DEFAULT false
  cancelled_at TIMESTAMPTZ
  cancelled_by_user_id UUID REFERENCES app_user(id)
  rejected_at TIMESTAMPTZ
  rejected_by_user_id UUID REFERENCES app_user(id)
  rejection_reason TEXT
  room_id UUID REFERENCES room(id)
  sort_order INT
  estimated_duration_minutes INT
  actual_start_time TIMESTAMPTZ
  actual_end_time TIMESTAMPTZ
  case_type case_type
  anesthesia_modality anesthesia_modality
  admission_type TEXT
  checked_in_preop_at TIMESTAMPTZ
  checked_in_preop_by_user_id UUID REFERENCES app_user(id)
  patient_gender gender
  patient_date_of_birth DATE
  patient_initials VARCHAR(10)
  primary_organization_id UUID REFERENCES organization(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_case_facility, idx_case_surgeon, idx_case_status, idx_case_scheduled_date, idx_case_room_date
  Foreign Keys: facility_id -> facility(id), surgeon_id -> app_user(id), preference_card_version_id -> preference_card_version(id), activated_by_user_id -> app_user(id), cancelled_by_user_id -> app_user(id), rejected_by_user_id -> app_user(id), room_id -> room(id), checked_in_preop_by_user_id -> app_user(id), primary_organization_id -> organization(id)

case_requirement
  id UUID PRIMARY KEY
  case_id UUID NOT NULL REFERENCES surgical_case(id)
  catalog_id UUID NOT NULL REFERENCES item_catalog(id)
  quantity INT NOT NULL CHECK (quantity > 0)
  is_surgeon_override BOOLEAN NOT NULL DEFAULT false
  notes TEXT
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (case_id, catalog_id)
  Indexes: idx_case_req_case, idx_case_req_catalog
  Foreign Keys: case_id -> surgical_case(id), catalog_id -> item_catalog(id)

inventory_event (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  inventory_item_id UUID NOT NULL REFERENCES inventory_item(id)
  event_type inventory_event_type NOT NULL
  case_id UUID REFERENCES surgical_case(id)
  location_id UUID REFERENCES location(id)
  previous_location_id UUID REFERENCES location(id)
  sterility_status sterility_status
  notes TEXT
  performed_by_user_id UUID NOT NULL REFERENCES app_user(id)
  device_event_id UUID REFERENCES device_event(id)
  occurred_at TIMESTAMPTZ NOT NULL
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: inventory_event_no_update, inventory_event_no_delete (BEFORE UPDATE/DELETE - raises exception)
  Indexes: idx_inv_event_facility, idx_inv_event_item, idx_inv_event_case, idx_inv_event_type, idx_inv_event_occurred
  Foreign Keys: facility_id -> facility(id), inventory_item_id -> inventory_item(id), case_id -> surgical_case(id), location_id -> location(id), previous_location_id -> location(id), performed_by_user_id -> app_user(id), device_event_id -> device_event(id)

attestation (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  case_id UUID NOT NULL REFERENCES surgical_case(id)
  type attestation_type NOT NULL
  attested_by_user_id UUID NOT NULL REFERENCES app_user(id)
  readiness_state_at_time readiness_state NOT NULL
  notes TEXT
  is_voided BOOLEAN NOT NULL DEFAULT false
  voided_at TIMESTAMPTZ
  voided_by_user_id UUID REFERENCES app_user(id)
  cached_attestation_id UUID REFERENCES attestation(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: attestation_no_update, attestation_no_delete (BEFORE UPDATE/DELETE - raises exception)
  Indexes: idx_attestation_facility, idx_attestation_case, idx_attestation_type
  Foreign Keys: facility_id -> facility(id), case_id -> surgical_case(id), attested_by_user_id -> app_user(id), voided_by_user_id -> app_user(id), cached_attestation_id -> attestation(id)

device
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  name VARCHAR(255) NOT NULL
  device_type device_type NOT NULL
  location_id UUID REFERENCES location(id)
  active BOOLEAN NOT NULL DEFAULT true
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_device_facility
  Foreign Keys: facility_id -> facility(id), location_id -> location(id)

device_event (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  device_id UUID NOT NULL REFERENCES device(id)
  device_type device_type NOT NULL
  payload_type device_payload_type NOT NULL
  raw_value TEXT NOT NULL
  processed_item_id UUID REFERENCES inventory_item(id)
  processed BOOLEAN NOT NULL DEFAULT false
  processing_error TEXT
  occurred_at TIMESTAMPTZ NOT NULL
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: device_event_no_update, device_event_no_delete (BEFORE UPDATE/DELETE - raises exception)
  Indexes: idx_device_event_facility, idx_device_event_device, idx_device_event_processed
  Foreign Keys: facility_id -> facility(id), device_id -> device(id), processed_item_id -> inventory_item(id)

case_readiness_cache (MUTABLE - recomputed from append-only events)
  case_id UUID PRIMARY KEY REFERENCES surgical_case(id)
  facility_id UUID NOT NULL REFERENCES facility(id)
  scheduled_date DATE NOT NULL
  procedure_name VARCHAR(255) NOT NULL
  surgeon_name VARCHAR(255) NOT NULL
  readiness_state readiness_state NOT NULL
  missing_items JSONB NOT NULL DEFAULT '[]' (Array of MissingItemReason)
  total_required_items INT NOT NULL DEFAULT 0
  total_verified_items INT NOT NULL DEFAULT 0
  has_attestation BOOLEAN NOT NULL DEFAULT false
  attested_at TIMESTAMPTZ
  attested_by_name VARCHAR(255)
  has_surgeon_acknowledgment BOOLEAN NOT NULL DEFAULT false
  surgeon_acknowledged_at TIMESTAMPTZ
  computed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_readiness_cache_facility_date, idx_readiness_cache_state
  Foreign Keys: case_id -> surgical_case(id), facility_id -> facility(id)

case_checklist_template
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  type checklist_type NOT NULL
  name VARCHAR(255) NOT NULL
  is_active BOOLEAN NOT NULL DEFAULT true
  current_version_id UUID REFERENCES case_checklist_template_version(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_checklist_template_facility_type
  Foreign Keys: facility_id -> facility(id), current_version_id -> case_checklist_template_version(id)

case_checklist_template_version
  id UUID PRIMARY KEY
  template_id UUID NOT NULL REFERENCES case_checklist_template(id)
  version_number INT NOT NULL
  items JSONB NOT NULL (Array of {key, label, type, required, options?})
  required_signatures JSONB NOT NULL (Array of {role, required})
  effective_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  created_by_user_id UUID NOT NULL REFERENCES app_user(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (template_id, version_number)
  Indexes: idx_checklist_template_version_template
  Foreign Keys: template_id -> case_checklist_template(id), created_by_user_id -> app_user(id)

case_checklist_instance
  id UUID PRIMARY KEY
  case_id UUID NOT NULL REFERENCES surgical_case(id)
  facility_id UUID NOT NULL REFERENCES facility(id)
  type checklist_type NOT NULL
  template_version_id UUID NOT NULL REFERENCES case_checklist_template_version(id)
  status checklist_status NOT NULL DEFAULT 'NOT_STARTED'
  room_id UUID REFERENCES room(id)
  started_at TIMESTAMPTZ
  completed_at TIMESTAMPTZ
  created_by_user_id UUID NOT NULL REFERENCES app_user(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (case_id, type)
  Indexes: idx_checklist_instance_case, idx_checklist_instance_facility_type
  Foreign Keys: case_id -> surgical_case(id), facility_id -> facility(id), template_version_id -> case_checklist_template_version(id), room_id -> room(id), created_by_user_id -> app_user(id)

case_checklist_response (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  instance_id UUID NOT NULL REFERENCES case_checklist_instance(id)
  item_key VARCHAR(100) NOT NULL
  value TEXT NOT NULL
  completed_by_user_id UUID NOT NULL REFERENCES app_user(id)
  completed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: case_checklist_response_no_update, case_checklist_response_no_delete
  Indexes: idx_checklist_response_instance
  Foreign Keys: instance_id -> case_checklist_instance(id), completed_by_user_id -> app_user(id)

case_checklist_signature (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  instance_id UUID NOT NULL REFERENCES case_checklist_instance(id)
  role VARCHAR(50) NOT NULL
  signed_by_user_id UUID NOT NULL REFERENCES app_user(id)
  signed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  method signature_method NOT NULL
  flagged_for_review BOOLEAN NOT NULL DEFAULT false
  flag_comment TEXT
  resolved BOOLEAN NOT NULL DEFAULT false
  resolved_at TIMESTAMPTZ
  resolved_by_user_id UUID REFERENCES app_user(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: case_checklist_signature_no_update, case_checklist_signature_no_delete
  Indexes: idx_checklist_signature_instance, idx_checklist_signature_flagged
  Foreign Keys: instance_id -> case_checklist_instance(id), signed_by_user_id -> app_user(id), resolved_by_user_id -> app_user(id)

facility_settings
  id UUID PRIMARY KEY
  facility_id UUID UNIQUE NOT NULL REFERENCES facility(id)
  enable_timeout_debrief BOOLEAN NOT NULL DEFAULT false
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Foreign Keys: facility_id -> facility(id)

case_card
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  case_id UUID UNIQUE NOT NULL REFERENCES surgical_case(id)
  preference_card_version_id UUID REFERENCES preference_card_version(id)
  status case_card_status NOT NULL DEFAULT 'PENDING_VERIFICATION'
  linked_at TIMESTAMPTZ
  linked_by_user_id UUID REFERENCES app_user(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_case_card_facility, idx_case_card_case
  Foreign Keys: facility_id -> facility(id), case_id -> surgical_case(id), preference_card_version_id -> preference_card_version(id), linked_by_user_id -> app_user(id)

case_card_item
  id UUID PRIMARY KEY
  case_card_id UUID NOT NULL REFERENCES case_card(id)
  catalog_id UUID NOT NULL REFERENCES item_catalog(id)
  quantity INT NOT NULL CHECK (quantity > 0)
  notes TEXT
  is_surgeon_override BOOLEAN NOT NULL DEFAULT false
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (case_card_id, catalog_id)
  Indexes: idx_case_card_item_card
  Foreign Keys: case_card_id -> case_card(id), catalog_id -> item_catalog(id)

case_attestation_record
  id UUID PRIMARY KEY
  case_id UUID NOT NULL REFERENCES surgical_case(id)
  facility_id UUID NOT NULL REFERENCES facility(id)
  state attestation_state NOT NULL
  performed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  performed_by_user_id UUID NOT NULL REFERENCES app_user(id)
  notes TEXT
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_case_attestation_case, idx_case_attestation_facility
  Foreign Keys: case_id -> surgical_case(id), facility_id -> facility(id), performed_by_user_id -> app_user(id)

case_event
  id UUID PRIMARY KEY
  case_id UUID NOT NULL REFERENCES surgical_case(id)
  facility_id UUID NOT NULL REFERENCES facility(id)
  event_type case_event_type NOT NULL
  event_timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW()
  performed_by_user_id UUID REFERENCES app_user(id)
  metadata JSONB
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_case_event_case, idx_case_event_facility, idx_case_event_type
  Foreign Keys: case_id -> surgical_case(id), facility_id -> facility(id), performed_by_user_id -> app_user(id)

room
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  name VARCHAR(100) NOT NULL
  active BOOLEAN NOT NULL DEFAULT true
  sort_order INT NOT NULL DEFAULT 0
  surgeon_color VARCHAR(7)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_room_facility
  Foreign Keys: facility_id -> facility(id)

facility_config_item
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  item_type config_item_type NOT NULL
  item_key VARCHAR(100) NOT NULL
  display_label VARCHAR(255) NOT NULL
  description TEXT
  sort_order INT NOT NULL DEFAULT 0
  active BOOLEAN NOT NULL DEFAULT true
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (facility_id, item_type, item_key)
  Indexes: idx_facility_config_item_facility_type
  Foreign Keys: facility_id -> facility(id)

block_time
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  room_id UUID NOT NULL REFERENCES room(id)
  block_date DATE NOT NULL
  duration_minutes INT NOT NULL
  notes TEXT
  sort_order INT NOT NULL DEFAULT 0
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  created_by_user_id UUID REFERENCES app_user(id)
  Indexes: idx_block_time_facility_room_date
  Foreign Keys: facility_id -> facility(id), room_id -> room(id), created_by_user_id -> app_user(id)

room_day_config
  id UUID PRIMARY KEY
  room_id UUID NOT NULL REFERENCES room(id)
  config_date DATE NOT NULL
  start_time TIME NOT NULL
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (room_id, config_date)
  Indexes: idx_room_day_config_room_date
  Foreign Keys: room_id -> room(id)

catalog_group
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  name VARCHAR(255) NOT NULL
  description TEXT
  active BOOLEAN NOT NULL DEFAULT true
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (facility_id, name)
  Indexes: idx_catalog_group_facility
  Foreign Keys: facility_id -> facility(id)

catalog_group_membership
  id UUID PRIMARY KEY
  group_id UUID NOT NULL REFERENCES catalog_group(id) ON DELETE CASCADE
  catalog_id UUID NOT NULL REFERENCES item_catalog(id) ON DELETE CASCADE
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (group_id, catalog_id)
  Indexes: idx_catalog_group_membership_group, idx_catalog_group_membership_catalog
  Foreign Keys: group_id -> catalog_group(id), catalog_id -> item_catalog(id)

catalog_set_component
  id UUID PRIMARY KEY
  set_catalog_id UUID NOT NULL REFERENCES item_catalog(id) ON DELETE CASCADE
  component_catalog_id UUID NOT NULL REFERENCES item_catalog(id)
  required_quantity INT NOT NULL DEFAULT 0 CHECK (required_quantity >= 0)
  optional_quantity INT NOT NULL DEFAULT 0 CHECK (optional_quantity >= 0)
  notes TEXT
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (set_catalog_id, component_catalog_id)
  Indexes: idx_catalog_set_component_set, idx_catalog_set_component_component
  Foreign Keys: set_catalog_id -> item_catalog(id), component_catalog_id -> item_catalog(id)

catalog_event (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  catalog_id UUID NOT NULL REFERENCES item_catalog(id)
  event_type TEXT NOT NULL
  old_value JSONB
  new_value JSONB
  changed_by_user_id UUID NOT NULL REFERENCES app_user(id)
  occurred_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: catalog_event_no_update, catalog_event_no_delete
  Indexes: idx_catalog_event_catalog, idx_catalog_event_occurred
  Foreign Keys: facility_id -> facility(id), catalog_id -> item_catalog(id), changed_by_user_id -> app_user(id)

idempotency_key
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  idempotency_key VARCHAR(255) NOT NULL
  route_pattern VARCHAR(255) NOT NULL
  request_hash VARCHAR(64) NOT NULL
  response_status INT NOT NULL
  response_body JSONB
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  expires_at TIMESTAMPTZ NOT NULL
  Unique Constraints: (facility_id, idempotency_key)
  Indexes: idx_idempotency_key_facility, idx_idempotency_key_expires
  Foreign Keys: facility_id -> facility(id)

vendor
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  name VARCHAR(255) NOT NULL
  vendor_type vendor_type NOT NULL
  contact_name VARCHAR(255)
  contact_email VARCHAR(255)
  contact_phone VARCHAR(50)
  notes TEXT
  active BOOLEAN NOT NULL DEFAULT true
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (facility_id, name)
  Indexes: idx_vendor_facility
  Foreign Keys: facility_id -> facility(id)

loaner_set
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  vendor_id UUID NOT NULL REFERENCES vendor(id)
  catalog_id UUID REFERENCES item_catalog(id)
  name VARCHAR(255) NOT NULL
  expected_return_date DATE
  notes TEXT
  checked_in_at TIMESTAMPTZ
  checked_in_by_user_id UUID REFERENCES app_user(id)
  checked_out_at TIMESTAMPTZ
  checked_out_by_user_id UUID REFERENCES app_user(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_loaner_set_facility, idx_loaner_set_vendor
  Foreign Keys: facility_id -> facility(id), vendor_id -> vendor(id), catalog_id -> item_catalog(id), checked_in_by_user_id -> app_user(id), checked_out_by_user_id -> app_user(id)

source_event (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  inventory_item_id UUID NOT NULL REFERENCES inventory_item(id)
  event_type source_event_type NOT NULL
  ownership_type ownership_type NOT NULL
  vendor_id UUID REFERENCES vendor(id)
  loaner_set_id UUID REFERENCES loaner_set(id)
  cost_override_cents BIGINT
  cost_override_reason cost_override_reason
  is_gratis BOOLEAN NOT NULL DEFAULT false
  gratis_reason gratis_reason
  notes TEXT
  occurred_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  recorded_by_user_id UUID NOT NULL REFERENCES app_user(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: source_event_no_update, source_event_no_delete
  Indexes: idx_source_event_item, idx_source_event_facility, idx_source_event_occurred
  Foreign Keys: facility_id -> facility(id), inventory_item_id -> inventory_item(id), vendor_id -> vendor(id), loaner_set_id -> loaner_set(id), recorded_by_user_id -> app_user(id)

catalog_image
  id UUID PRIMARY KEY
  catalog_id UUID NOT NULL REFERENCES item_catalog(id) ON DELETE CASCADE
  image_url TEXT NOT NULL
  display_order INT NOT NULL DEFAULT 0
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_catalog_image_catalog
  Foreign Keys: catalog_id -> item_catalog(id)

config_registry
  id UUID PRIMARY KEY
  config_key VARCHAR(255) UNIQUE NOT NULL
  scope config_scope NOT NULL
  value_type config_value_type NOT NULL
  default_value TEXT
  description TEXT
  risk_class config_risk_class NOT NULL DEFAULT 'MEDIUM'
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_config_registry_scope
  Foreign Keys: None

config_value
  id UUID PRIMARY KEY
  config_key VARCHAR(255) NOT NULL REFERENCES config_registry(config_key) ON DELETE CASCADE
  facility_id UUID REFERENCES facility(id)
  value TEXT NOT NULL
  set_by_user_id UUID REFERENCES app_user(id)
  set_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (config_key, facility_id)
  Indexes: idx_config_value_key, idx_config_value_facility
  Foreign Keys: config_key -> config_registry(config_key), facility_id -> facility(id), set_by_user_id -> app_user(id)

auth_audit_log (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  facility_id UUID REFERENCES facility(id)
  event_type TEXT NOT NULL
  username TEXT
  user_id UUID REFERENCES app_user(id)
  facility_key TEXT
  ip_address TEXT
  user_agent TEXT
  success BOOLEAN NOT NULL
  failure_reason TEXT
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: auth_audit_log_no_update, auth_audit_log_no_delete
  Indexes: idx_auth_audit_log_facility, idx_auth_audit_log_user, idx_auth_audit_log_created
  Foreign Keys: facility_id -> facility(id), user_id -> app_user(id)

case_card_link_event (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  case_id UUID NOT NULL REFERENCES surgical_case(id)
  event_type TEXT NOT NULL
  old_preference_card_version_id UUID REFERENCES preference_card_version(id)
  new_preference_card_version_id UUID REFERENCES preference_card_version(id)
  actor_user_id UUID NOT NULL REFERENCES app_user(id)
  context JSONB
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: case_card_link_event_no_update, case_card_link_event_no_delete
  Indexes: idx_case_card_link_event_case, idx_case_card_link_event_created
  Foreign Keys: case_id -> surgical_case(id), old_preference_card_version_id -> preference_card_version(id), new_preference_card_version_id -> preference_card_version(id), actor_user_id -> app_user(id)

organization
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  name VARCHAR(255) NOT NULL
  organization_type organization_type NOT NULL
  is_active BOOLEAN NOT NULL DEFAULT true
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (facility_id, name), idx_one_asc_per_facility (facility_id WHERE organization_type='ASC' AND is_active=true)
  Indexes: idx_organization_facility, idx_organization_type
  Foreign Keys: facility_id -> facility(id)

user_organization_affiliation
  id UUID PRIMARY KEY
  user_id UUID NOT NULL REFERENCES app_user(id)
  organization_id UUID NOT NULL REFERENCES organization(id)
  affiliation_type affiliation_type NOT NULL
  is_active BOOLEAN NOT NULL DEFAULT true
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (user_id, organization_id, affiliation_type)
  Indexes: idx_user_organization_affiliation_user, idx_user_organization_affiliation_org
  Foreign Keys: user_id -> app_user(id), organization_id -> organization(id)

surgical_case_access_grant
  id UUID PRIMARY KEY
  surgical_case_id UUID NOT NULL REFERENCES surgical_case(id) ON DELETE CASCADE
  organization_id UUID NOT NULL REFERENCES organization(id) ON DELETE CASCADE
  grant_type TEXT NOT NULL DEFAULT 'PRIMARY'
  granted_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  granted_by_user_id UUID REFERENCES app_user(id)
  revoked_at TIMESTAMPTZ
  revoked_by_user_id UUID REFERENCES app_user(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_case_access_grant_case, idx_case_access_grant_org
  Foreign Keys: surgical_case_id -> surgical_case(id), organization_id -> organization(id), granted_by_user_id -> app_user(id), revoked_by_user_id -> app_user(id)

phi_access_log (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  user_id UUID NOT NULL REFERENCES app_user(id)
  organization_id UUID REFERENCES organization(id)
  surgical_case_id UUID REFERENCES surgical_case(id)
  phi_classification phi_classification NOT NULL
  access_purpose access_purpose NOT NULL
  outcome access_outcome NOT NULL
  denial_reason TEXT
  route_pattern TEXT
  ip_address TEXT
  user_agent TEXT
  request_metadata JSONB
  accessed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: phi_access_log_no_update, phi_access_log_no_delete
  Indexes: idx_phi_access_log_facility, idx_phi_access_log_user, idx_phi_access_log_case, idx_phi_access_log_accessed
  Foreign Keys: facility_id -> facility(id), user_id -> app_user(id), organization_id -> organization(id), surgical_case_id -> surgical_case(id)

phi_access_log_detail
  id UUID PRIMARY KEY
  access_log_id UUID NOT NULL REFERENCES phi_access_log(id) ON DELETE CASCADE
  field_name TEXT NOT NULL
  field_value TEXT
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_phi_access_log_detail_log
  Foreign Keys: access_log_id -> phi_access_log(id)

phi_retention_policy_cache
  id UUID PRIMARY KEY
  surgical_case_id UUID UNIQUE NOT NULL REFERENCES surgical_case(id) ON DELETE CASCADE
  facility_id UUID NOT NULL REFERENCES facility(id)
  primary_classification phi_classification NOT NULL
  scheduled_date DATE
  completed_at TIMESTAMPTZ
  retention_until_date DATE
  eligible_for_deletion BOOLEAN NOT NULL DEFAULT false
  deletion_approved_by_user_id UUID REFERENCES app_user(id)
  deletion_approved_at TIMESTAMPTZ
  computed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_phi_retention_cache_facility, idx_phi_retention_cache_eligible, idx_phi_retention_cache_retention_date
  Foreign Keys: surgical_case_id -> surgical_case(id), facility_id -> facility(id), deletion_approved_by_user_id -> app_user(id)

phi_breach_log (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  facility_id UUID NOT NULL REFERENCES facility(id)
  breach_type TEXT NOT NULL
  severity TEXT NOT NULL
  description TEXT NOT NULL
  affected_case_count INT
  affected_patient_count INT
  user_id UUID REFERENCES app_user(id)
  ip_address TEXT
  user_agent TEXT
  context JSONB
  detected_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: phi_breach_log_no_update, phi_breach_log_no_delete
  Indexes: idx_phi_breach_log_facility, idx_phi_breach_log_detected
  Foreign Keys: facility_id -> facility(id), user_id -> app_user(id)

surgical_case_status_event (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  surgical_case_id UUID NOT NULL REFERENCES surgical_case(id)
  from_status case_status
  to_status case_status NOT NULL
  context JSONB
  actor_user_id UUID REFERENCES app_user(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: surgical_case_status_event_no_update, surgical_case_status_event_no_delete
  Indexes: idx_surgical_case_status_event_case, idx_surgical_case_status_event_created
  Foreign Keys: surgical_case_id -> surgical_case(id), actor_user_id -> app_user(id)

clinic
  id UUID PRIMARY KEY
  name TEXT NOT NULL
  clinic_key TEXT UNIQUE NOT NULL
  active BOOLEAN NOT NULL DEFAULT true
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Foreign Keys: None

clinic_api_key
  id UUID PRIMARY KEY
  clinic_id UUID NOT NULL REFERENCES clinic(id) ON DELETE CASCADE
  key_prefix TEXT NOT NULL
  key_hash TEXT NOT NULL
  active BOOLEAN NOT NULL DEFAULT true
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_clinic_api_key_prefix WHERE active=true
  Foreign Keys: clinic_id -> clinic(id)

patient_ref
  id UUID PRIMARY KEY
  clinic_id UUID NOT NULL REFERENCES clinic(id)
  clinic_patient_key TEXT NOT NULL
  display_name TEXT
  birth_year INT
  dedupe_hash TEXT
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (clinic_id, clinic_patient_key)
  Foreign Keys: clinic_id -> clinic(id)

surgery_request
  id UUID PRIMARY KEY
  target_facility_id UUID NOT NULL REFERENCES facility(id)
  source_clinic_id UUID NOT NULL REFERENCES clinic(id)
  source_request_id TEXT NOT NULL
  status surgery_request_status NOT NULL DEFAULT 'SUBMITTED'
  procedure_name TEXT NOT NULL
  surgeon_id UUID REFERENCES app_user(id)
  scheduled_date DATE
  scheduled_time TIME
  patient_ref_id UUID NOT NULL REFERENCES patient_ref(id)
  submitted_at TIMESTAMPTZ NOT NULL
  last_submitted_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (source_clinic_id, source_request_id)
  Indexes: idx_surgery_request_facility_status, idx_surgery_request_clinic, idx_surgery_request_surgeon WHERE surgeon_id IS NOT NULL, idx_surgery_request_scheduled WHERE scheduled_date IS NOT NULL
  Foreign Keys: target_facility_id -> facility(id), source_clinic_id -> clinic(id), surgeon_id -> app_user(id), patient_ref_id -> patient_ref(id)

surgery_request_submission (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  request_id UUID NOT NULL REFERENCES surgery_request(id) ON DELETE CASCADE
  submission_seq INT NOT NULL
  submitted_at TIMESTAMPTZ NOT NULL
  received_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  payload_version INT NOT NULL DEFAULT 1
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (request_id, submission_seq)
  Triggers: surgery_request_submission_no_update, surgery_request_submission_no_delete
  Foreign Keys: request_id -> surgery_request(id)

surgery_request_checklist_template_version
  id UUID PRIMARY KEY
  target_facility_id UUID NOT NULL REFERENCES facility(id)
  name TEXT NOT NULL
  version INT NOT NULL
  schema JSONB NOT NULL
  active BOOLEAN NOT NULL DEFAULT true
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Unique Constraints: (target_facility_id, name, version)
  Indexes: idx_checklist_template_facility_active WHERE active=true
  Foreign Keys: target_facility_id -> facility(id)

surgery_request_checklist_instance
  id UUID PRIMARY KEY
  request_id UUID NOT NULL REFERENCES surgery_request(id) ON DELETE CASCADE
  submission_id UUID NOT NULL REFERENCES surgery_request_submission(id) ON DELETE CASCADE
  template_version_id UUID NOT NULL REFERENCES surgery_request_checklist_template_version(id)
  status surgery_request_checklist_status NOT NULL DEFAULT 'PENDING'
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_checklist_instance_request, idx_checklist_instance_submission
  Foreign Keys: request_id -> surgery_request(id), submission_id -> surgery_request_submission(id), template_version_id -> surgery_request_checklist_template_version(id)

surgery_request_checklist_response (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  instance_id UUID NOT NULL REFERENCES surgery_request_checklist_instance(id) ON DELETE CASCADE
  item_key TEXT NOT NULL
  response JSONB NOT NULL
  actor_type surgery_request_actor_type NOT NULL
  actor_clinic_id UUID REFERENCES clinic(id)
  actor_user_id UUID REFERENCES app_user(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: surgery_request_checklist_response_no_update, surgery_request_checklist_response_no_delete
  Indexes: idx_checklist_response_instance
  Foreign Keys: instance_id -> surgery_request_checklist_instance(id), actor_clinic_id -> clinic(id), actor_user_id -> app_user(id)

surgery_request_audit_event (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  request_id UUID NOT NULL REFERENCES surgery_request(id) ON DELETE CASCADE
  submission_id UUID REFERENCES surgery_request_submission(id)
  event_type surgery_request_event_type NOT NULL
  actor_type surgery_request_actor_type NOT NULL
  actor_clinic_id UUID REFERENCES clinic(id)
  actor_user_id UUID REFERENCES app_user(id)
  reason_code TEXT
  note TEXT
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: surgery_request_audit_event_no_update, surgery_request_audit_event_no_delete
  Indexes: idx_surgery_request_audit_request, idx_surgery_request_audit_event_type
  Foreign Keys: request_id -> surgery_request(id), submission_id -> surgery_request_submission(id), actor_clinic_id -> clinic(id), actor_user_id -> app_user(id)

surgery_request_conversion (APPEND-ONLY - NO UPDATE/DELETE allowed)
  request_id UUID PRIMARY KEY REFERENCES surgery_request(id) ON DELETE CASCADE
  surgical_case_id UUID UNIQUE NOT NULL REFERENCES surgical_case(id)
  converted_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  converted_by_user_id UUID NOT NULL REFERENCES app_user(id)
  Triggers: surgery_request_conversion_no_update, surgery_request_conversion_no_delete
  Foreign Keys: request_id -> surgery_request(id), surgical_case_id -> surgical_case(id), converted_by_user_id -> app_user(id)

clinic_financial_declaration (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  surgery_request_id UUID NOT NULL REFERENCES surgery_request(id) ON DELETE CASCADE
  state clinic_financial_state NOT NULL
  reason_codes TEXT[] NOT NULL DEFAULT '{}'
  note TEXT
  actor_clinic_id UUID NOT NULL REFERENCES clinic(id)
  recorded_by_user_id UUID NOT NULL REFERENCES app_user(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: clinic_financial_declaration_no_update, clinic_financial_declaration_no_delete
  Indexes: idx_clinic_financial_declaration_request
  Foreign Keys: surgery_request_id -> surgery_request(id), actor_clinic_id -> clinic(id), recorded_by_user_id -> app_user(id)

asc_financial_verification (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  surgery_request_id UUID NOT NULL REFERENCES surgery_request(id) ON DELETE CASCADE
  state asc_financial_state NOT NULL
  reason_codes TEXT[] NOT NULL DEFAULT '{}'
  note TEXT
  verified_by_user_id UUID NOT NULL REFERENCES app_user(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Triggers: asc_financial_verification_no_update, asc_financial_verification_no_delete
  Indexes: idx_asc_financial_verification_request
  Foreign Keys: surgery_request_id -> surgery_request(id), verified_by_user_id -> app_user(id)

financial_override (APPEND-ONLY - NO UPDATE/DELETE allowed)
  id UUID PRIMARY KEY
  surgery_request_id UUID NOT NULL REFERENCES surgery_request(id) ON DELETE CASCADE
  state override_state NOT NULL
  reason_code override_reason_code
  note TEXT
  overridden_by_user_id UUID NOT NULL REFERENCES app_user(id)
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Constraint: chk_override_reason_code (state='NONE' requires reason_code IS NULL, state!='NONE' requires reason_code IS NOT NULL)
  Triggers: financial_override_no_update, financial_override_no_delete
  Indexes: idx_financial_override_request
  Foreign Keys: surgery_request_id -> surgery_request(id), overridden_by_user_id -> app_user(id)

financial_readiness_cache (MUTABLE - recomputed from append-only events)
  surgery_request_id UUID PRIMARY KEY REFERENCES surgery_request(id) ON DELETE CASCADE
  target_facility_id UUID NOT NULL REFERENCES facility(id)
  clinic_state clinic_financial_state NOT NULL DEFAULT 'UNKNOWN'
  asc_state asc_financial_state NOT NULL DEFAULT 'UNKNOWN'
  override_state override_state NOT NULL DEFAULT 'NONE'
  risk_state financial_risk_state NOT NULL DEFAULT 'UNKNOWN'
  last_clinic_declaration_id UUID REFERENCES clinic_financial_declaration(id)
  last_asc_verification_id UUID REFERENCES asc_financial_verification(id)
  last_override_id UUID REFERENCES financial_override(id)
  recomputed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
  Indexes: idx_financial_readiness_cache_facility_risk, idx_financial_readiness_cache_facility_risk_state
  Foreign Keys: surgery_request_id -> surgery_request(id), target_facility_id -> facility(id), last_clinic_declaration_id -> clinic_financial_declaration(id), last_asc_verification_id -> asc_financial_verification(id), last_override_id -> financial_override(id)

================================================================================
3. ENUMS AND STATUS FIELDS
================================================================================

user_role (apps/api/db/migrations/001_initial_schema.sql, extended in 006, 045)
Values: ADMIN, SCHEDULER, INVENTORY_TECH, CIRCULATOR, SURGEON, SCRUB, ANESTHESIA, PLATFORM_ADMIN
Defined: apps/api/db/migrations/001_initial_schema.sql lines 14-20
Extended: 006_add_scrub_anesthesia_roles.sql (SCRUB, ANESTHESIA), 045_platform_admin_role.sql (PLATFORM_ADMIN)
Consumed: app_user.role (deprecated), app_user.roles[] (canonical)
Consumed: packages/domain/src/types.ts (lines 39-48) as Zod schema
Consumed: apps/api/src/schemas/index.ts for request validation
UI Behavior: Role-based authorization via ROLE_CAPABILITIES mapping (packages/domain/src/types.ts lines 183-212)

case_status (apps/api/db/migrations/001_initial_schema.sql, extended in 018, 041)
Values: DRAFT, REQUESTED, SCHEDULED, IN_PREOP, READY, IN_PROGRESS, COMPLETED, CANCELLED, REJECTED
Defined: apps/api/db/migrations/001_initial_schema.sql lines 22-29
Extended: 018_case_request_approval_workflow.sql (REQUESTED, REJECTED), 041_case_preop_phase.sql (IN_PREOP)
Consumed: surgical_case.status
Consumed: packages/domain/src/types.ts lines 227-238
UI Behavior: Case list filtering, status badges, workflow state transitions

readiness_state (apps/api/db/migrations/001_initial_schema.sql)
Values: GREEN, ORANGE, RED
Defined: apps/api/db/migrations/001_initial_schema.sql lines 31-35
Consumed: case_readiness_cache.readiness_state, attestation.readiness_state_at_time
Consumed: packages/domain/src/types.ts lines 240-245
UI Behavior: Day-before dashboard color coding, case readiness indicators

item_category (apps/api/db/migrations/001_initial_schema.sql, replaced in 032)
Original Values: IMPLANT, INSTRUMENT, LOANER, HIGH_VALUE_SUPPLY
Replaced Values: IMPLANT, INSTRUMENT, EQUIPMENT, MEDICATION, CONSUMABLE, PPE
Defined: apps/api/db/migrations/001_initial_schema.sql lines 37-42
Replaced: 032_align_categories_with_law.sql with item_category_new, then renamed
Consumed: item_catalog.category
Consumed: packages/domain/src/types.ts lines 248-256
UI Behavior: Catalog filtering, readiness calculations, criticality-based alerts

sterility_status (apps/api/db/migrations/001_initial_schema.sql)
Values: STERILE, NON_STERILE, EXPIRED, UNKNOWN
Defined: apps/api/db/migrations/001_initial_schema.sql lines 44-49
Consumed: inventory_item.sterility_status, inventory_event.sterility_status
Consumed: packages/domain/src/types.ts lines 266-272
UI Behavior: Inventory status displays, readiness validation

availability_status (apps/api/db/migrations/001_initial_schema.sql)
Values: AVAILABLE, RESERVED, IN_USE, UNAVAILABLE, MISSING
Defined: apps/api/db/migrations/001_initial_schema.sql lines 51-57
Consumed: inventory_item.availability_status
Consumed: packages/domain/src/types.ts lines 274-281
UI Behavior: Inventory allocation, case readiness checks

inventory_event_type (apps/api/db/migrations/001_initial_schema.sql)
Values: RECEIVED, VERIFIED, LOCATION_CHANGED, RESERVED, RELEASED, CONSUMED, EXPIRED, RETURNED, ADJUSTED
Defined: apps/api/db/migrations/001_initial_schema.sql lines 59-69
Consumed: inventory_event.event_type
Consumed: packages/domain/src/types.ts lines 283-294
UI Behavior: Inventory audit trail, event filtering

attestation_type (apps/api/db/migrations/001_initial_schema.sql)
Values: CASE_READINESS, SURGEON_ACKNOWLEDGMENT
Defined: apps/api/db/migrations/001_initial_schema.sql lines 71-74
Consumed: attestation.type
Consumed: packages/domain/src/types.ts lines 296-300
UI Behavior: Day-before attestation workflow, surgeon red-case acknowledgment

device_type (apps/api/db/migrations/001_initial_schema.sql)
Values: barcode, rfid, nfc, other
Defined: apps/api/db/migrations/001_initial_schema.sql lines 76-81
Consumed: device.device_type, device_event.device_type
Consumed: packages/domain/src/types.ts lines 574-575
UI Behavior: Device adapter routing

device_payload_type (apps/api/db/migrations/001_initial_schema.sql)
Values: scan, presence, input
Defined: apps/api/db/migrations/001_initial_schema.sql lines 83-87
Consumed: device_event.payload_type
Consumed: packages/domain/src/types.ts lines 577-578
UI Behavior: Device event parsing

checklist_type (apps/api/db/migrations/004_timeout_debrief.sql)
Values: TIMEOUT, DEBRIEF
Defined: apps/api/db/migrations/004_timeout_debrief.sql line 8
Consumed: case_checklist_template.type, case_checklist_instance.type
Consumed: packages/domain/src/types.ts lines 660-661
UI Behavior: Checklist workflow selection

checklist_status (apps/api/db/migrations/004_timeout_debrief.sql)
Values: NOT_STARTED, IN_PROGRESS, COMPLETED
Defined: apps/api/db/migrations/004_timeout_debrief.sql line 9
Consumed: case_checklist_instance.status
Consumed: packages/domain/src/types.ts lines 663-664
UI Behavior: Checklist workflow state, case progression gates

signature_method (apps/api/db/migrations/004_timeout_debrief.sql)
Values: LOGIN, PIN, BADGE, KIOSK_TAP
Defined: apps/api/db/migrations/004_timeout_debrief.sql line 10
Consumed: case_checklist_signature.method
Consumed: packages/domain/src/types.ts lines 666-667
UI Behavior: Signature authentication method tracking

anesthesia_modality (apps/api/db/migrations/012_case_dashboard.sql, extended in 013)
Values: GENERAL, MAC, REGIONAL, LOCAL, NONE
Extended Values: + TIVA
Defined: apps/api/db/migrations/012_case_dashboard.sql lines 14-21
Extended: 013_modality_array_tiva.sql (TIVA added)
Consumed: surgical_case.anesthesia_modality
UI Behavior: Case dashboard anesthesia selection

attestation_state (apps/api/db/migrations/012_case_dashboard.sql)
Values: VERIFIED, ACKNOWLEDGED, FLAGGED
Defined: apps/api/db/migrations/012_case_dashboard.sql lines 22-26
Consumed: case_attestation_record.state
UI Behavior: Case attestation workflow

case_event_type (apps/api/db/migrations/012_case_dashboard.sql)
Values: CHECKED_IN, TIMEOUT_STARTED, INCISION, CLOSURE, DEBRIEF_COMPLETED
Defined: apps/api/db/migrations/012_case_dashboard.sql lines 28-34
Consumed: case_event.event_type
UI Behavior: Case timeline, event logging

case_card_status (apps/api/db/migrations/011_case_cards.sql)
Values: PENDING_VERIFICATION, VERIFIED, OVERRIDDEN
Defined: apps/api/db/migrations/011_case_cards.sql lines 12-16
Consumed: case_card.status
UI Behavior: Case-specific card linkage workflow

case_type (apps/api/db/migrations/011_case_cards.sql)
Values: STANDARD, URGENT, EMERGENT
Defined: apps/api/db/migrations/011_case_cards.sql lines 18-22
Consumed: surgical_case.case_type
UI Behavior: Case prioritization, scheduling

config_item_type (apps/api/db/migrations/022_facility_config_items.sql)
Values: PATIENT_FLAG, ANESTHESIA_MODALITY
Defined: apps/api/db/migrations/022_facility_config_items.sql lines 8-11
Consumed: facility_config_item.item_type
UI Behavior: General settings UI, extensible configuration

criticality (apps/api/db/migrations/030_catalog_v1_1_risk_intent.sql)
Values: CRITICAL, IMPORTANT, ROUTINE
Defined: apps/api/db/migrations/030_catalog_v1_1_risk_intent.sql lines 9-13
Consumed: item_catalog.criticality
Consumed: packages/domain/src/types.ts lines 259-264
UI Behavior: Alarm priority, readiness warnings

vendor_type (apps/api/db/migrations/043_financial_attribution.sql)
Values: IMPLANT_MANUFACTURER, INSTRUMENT_MANUFACTURER, DISTRIBUTOR
Defined: apps/api/db/migrations/043_financial_attribution.sql lines 19-23
Consumed: vendor.vendor_type
UI Behavior: Vendor categorization

ownership_type (apps/api/db/migrations/043_financial_attribution.sql)
Values: FACILITY_OWNED, CONSIGNMENT, LOANER, VENDOR_TRIAL
Defined: apps/api/db/migrations/043_financial_attribution.sql lines 26-30
Consumed: source_event.ownership_type
UI Behavior: Financial attribution, billing

source_event_type (apps/api/db/migrations/043_financial_attribution.sql)
Values: RECEIVED_PURCHASE, RECEIVED_CONSIGNMENT, RECEIVED_LOANER, RECEIVED_TRIAL, RETURNED_VENDOR, TRANSFERRED_OWNERSHIP, OTHER
Defined: apps/api/db/migrations/043_financial_attribution.sql lines 33-39
Consumed: source_event.event_type
UI Behavior: Inventory source tracking

cost_override_reason (apps/api/db/migrations/043_financial_attribution.sql)
Values: NEGOTIATED_DISCOUNT, CONTRACTUAL_ADJUSTMENT, WARRANTY_REPLACEMENT, RETURN_CREDIT, BILLING_CORRECTION, ADMIN_ADJUSTMENT, OTHER
Defined: apps/api/db/migrations/043_financial_attribution.sql lines 41-49
Consumed: source_event.cost_override_reason
UI Behavior: Cost adjustment justification

gratis_reason (apps/api/db/migrations/043_financial_attribution.sql)
Values: EVALUATION_SAMPLE, WARRANTY_REPLACEMENT, VENDOR_COURTESY, RECALL_REPLACEMENT, TRAINING_DEMO, OTHER
Defined: apps/api/db/migrations/043_financial_attribution.sql lines 52-59
Consumed: source_event.gratis_reason
UI Behavior: Zero-cost item tracking

config_scope (apps/api/db/migrations/047_config_registry.sql)
Values: PLATFORM, FACILITY
Defined: apps/api/db/migrations/047_config_registry.sql line 17
Consumed: config_registry.scope
Consumed: packages/domain/src/types.ts lines 117-118
UI Behavior: Configuration visibility, override hierarchy

config_value_type (apps/api/db/migrations/047_config_registry.sql)
Values: STRING, BOOLEAN, NUMBER, JSON
Defined: apps/api/db/migrations/047_config_registry.sql line 20
Consumed: config_registry.value_type
Consumed: packages/domain/src/types.ts lines 121-122
UI Behavior: Configuration editor validation

config_risk_class (apps/api/db/migrations/047_config_registry.sql)
Values: LOW, MEDIUM, HIGH, CRITICAL
Defined: apps/api/db/migrations/047_config_registry.sql lines 23-27
Consumed: config_registry.risk_class
Consumed: packages/domain/src/types.ts lines 125-126
UI Behavior: Configuration change approval workflows

organization_type (apps/api/db/migrations/051_organization_model.sql)
Values: ASC, SURGEON_GROUP, OFFICE, BILLING_ENTITY
Defined: apps/api/db/migrations/051_organization_model.sql lines 9-14
Consumed: organization.organization_type
Consumed: packages/domain/src/types.ts lines 70-75
UI Behavior: PHI access scoping, organizational isolation

affiliation_type (apps/api/db/migrations/052_user_organization_affiliation.sql)
Values: PRIMARY, SECONDARY
Defined: apps/api/db/migrations/052_user_organization_affiliation.sql line 9
Consumed: user_organization_affiliation.affiliation_type
Consumed: packages/domain/src/types.ts lines 79-82
UI Behavior: Multi-organization membership

phi_classification (apps/api/db/migrations/054_phi_access_audit_log.sql)
Values: PHI_CLINICAL, PHI_BILLING, PHI_AUDIT
Defined: apps/api/db/migrations/054_phi_access_audit_log.sql line 9
Consumed: phi_access_log.phi_classification, phi_retention_policy_cache.primary_classification
Consumed: packages/domain/src/types.ts lines 56-57
UI Behavior: Data visibility rules, retention policies

access_purpose (apps/api/db/migrations/054_phi_access_audit_log.sql)
Values: CLINICAL_CARE, SCHEDULING, BILLING, AUDIT, EMERGENCY
Defined: apps/api/db/migrations/054_phi_access_audit_log.sql line 10
Consumed: phi_access_log.access_purpose
Consumed: packages/domain/src/types.ts lines 60-66
UI Behavior: Access justification, audit trails

access_outcome (apps/api/db/migrations/054_phi_access_audit_log.sql)
Values: ALLOWED, DENIED
Defined: apps/api/db/migrations/054_phi_access_audit_log.sql line 11
Consumed: phi_access_log.outcome
UI Behavior: Access control audit

gender (apps/api/db/migrations/058_phi_patient_gender.sql)
Values: MALE, FEMALE, OTHER, UNKNOWN
Defined: apps/api/db/migrations/058_phi_patient_gender.sql
Consumed: surgical_case.patient_gender
Consumed: packages/domain/src/types.ts lines 86-88
UI Behavior: Patient identity for surgical timeout

surgery_request_status (apps/api/db/migrations/059_surgery_request.sql)
Values: SUBMITTED, RETURNED_TO_CLINIC, ACCEPTED, REJECTED, WITHDRAWN, CONVERTED
Defined: apps/api/db/migrations/059_surgery_request.sql lines 10-16
Consumed: surgery_request.status
Consumed: packages/domain/src/types.ts lines 306-314
UI Behavior: Surgery request workflow state machine (packages/domain/src/types.ts lines 347-354)

surgery_request_event_type (apps/api/db/migrations/059_surgery_request.sql)
Values: SUBMITTED, RESUBMITTED, RETURNED, ACCEPTED, REJECTED, WITHDRAWN, CONVERTED
Defined: apps/api/db/migrations/059_surgery_request.sql lines 19-27
Consumed: surgery_request_audit_event.event_type
Consumed: packages/domain/src/types.ts lines 316-325
UI Behavior: Audit trail event types

surgery_request_checklist_status (apps/api/db/migrations/059_surgery_request.sql)
Values: PENDING, COMPLETE
Defined: apps/api/db/migrations/059_surgery_request.sql lines 29-32
Consumed: surgery_request_checklist_instance.status
Consumed: packages/domain/src/types.ts lines 330-331
UI Behavior: Checklist completion tracking

surgery_request_actor_type (apps/api/db/migrations/059_surgery_request.sql)
Values: CLINIC, ASC
Defined: apps/api/db/migrations/059_surgery_request.sql lines 34-37
Consumed: surgery_request_checklist_response.actor_type, surgery_request_audit_event.actor_type
Consumed: packages/domain/src/types.ts lines 327-328
UI Behavior: Actor attribution in multi-tenant workflow

clinic_financial_state (apps/api/db/migrations/060_financial_readiness.sql)
Values: UNKNOWN, DECLARED_CLEARED, DECLARED_AT_RISK
Defined: apps/api/db/migrations/060_financial_readiness.sql lines 11-15
Consumed: clinic_financial_declaration.state, financial_readiness_cache.clinic_state
Consumed: packages/domain/src/types.ts lines 360-361
UI Behavior: Clinic-side financial readiness declaration

asc_financial_state (apps/api/db/migrations/060_financial_readiness.sql)
Values: UNKNOWN, VERIFIED_CLEARED, VERIFIED_AT_RISK
Defined: apps/api/db/migrations/060_financial_readiness.sql lines 17-21
Consumed: asc_financial_verification.state, financial_readiness_cache.asc_state
Consumed: packages/domain/src/types.ts lines 363-364
UI Behavior: ASC-side financial verification

override_state (apps/api/db/migrations/060_financial_readiness.sql)
Values: NONE, OVERRIDE_CLEARED, OVERRIDE_AT_RISK
Defined: apps/api/db/migrations/060_financial_readiness.sql lines 23-27
Consumed: financial_override.state, financial_readiness_cache.override_state
Consumed: packages/domain/src/types.ts lines 366-367
UI Behavior: Admin override of computed financial risk

financial_risk_state (apps/api/db/migrations/060_financial_readiness.sql)
Values: UNKNOWN, LOW, MEDIUM, HIGH
Defined: apps/api/db/migrations/060_financial_readiness.sql lines 29-34
Consumed: financial_readiness_cache.risk_state
Consumed: packages/domain/src/types.ts lines 369-370
UI Behavior: Computed financial risk indicator

override_reason_code (apps/api/db/migrations/060_financial_readiness.sql)
Values: ADMIN_JUDGMENT, URGENT_CASE, CLINIC_CONFIRMED, PATIENT_PAID, OTHER
Defined: apps/api/db/migrations/060_financial_readiness.sql lines 36-42
Consumed: financial_override.reason_code
Consumed: packages/domain/src/types.ts lines 372-375
UI Behavior: Override justification

================================================================================
4. MIGRATIONS
================================================================================

Migration files are located in apps/api/db/migrations/*.sql
Total count: 61 files
Executed by: apps/api/db/migrate.ts (custom migration runner, sequential by filename)

001_initial_schema.sql
Creates: facility, app_user, location, item_catalog, inventory_item, preference_card, preference_card_version, surgical_case, case_requirement, inventory_event, attestation, device, device_event, case_readiness_cache
Enums: user_role, case_status, readiness_state, item_category, sterility_status, availability_status, inventory_event_type, attestation_type, device_type, device_payload_type
Functions: prevent_modification() (for append-only protection), update_updated_at()
Triggers: Append-only triggers on inventory_event, attestation, device_event; updated_at triggers on mutable tables

002_attestation_voiding.sql
Adds: attestation.is_voided, voided_at, voided_by_user_id

003_cache_attestation_id.sql
Adds: case_readiness_cache.cached_attestation_id (FK to attestation)

004_timeout_debrief.sql
Creates: case_checklist_template, case_checklist_template_version, case_checklist_instance, case_checklist_response, case_checklist_signature, facility_settings, room
Enums: checklist_type, checklist_status, signature_method

005_debrief_conditional_signatures.sql
Adds: case_checklist_signature.flagged_for_review, flag_comment, resolved, resolved_at, resolved_by_user_id

006_add_scrub_anesthesia_roles.sql
Extends user_role enum with: SCRUB, ANESTHESIA

007_username_auth.sql
Adds: app_user.username UNIQUE (facility_id, username), makes email nullable

008_case_active_status.sql
Adds: surgical_case.is_active, activated_at, activated_by_user_id (for inactive/active workflow)

009_nullable_scheduled_date.sql
Makes surgical_case.scheduled_date nullable (until activation)

010_facility_key.sql
Adds: facility.facility_key UNIQUE NOT NULL (tenant identifier)

011_case_cards.sql
Creates: case_card, case_card_item
Enums: case_card_status, case_type
Adds: surgical_case.case_type

012_case_dashboard.sql
Enums: anesthesia_modality, attestation_state, case_event_type
Creates: case_attestation_record, case_event
Adds: surgical_case.room_id, sort_order, estimated_duration_minutes, anesthesia_modality, actual_start_time, actual_end_time

013_modality_array_tiva.sql
Extends anesthesia_modality enum with: TIVA

014_feedback_review.sql
Updates: case_checklist_signature indexing for flagged_for_review queries

015_case_card_governance.sql
Adds: case_card.linked_at, linked_by_user_id (audit trail for preference card linking)

016_case_specific_fields.sql
Adds: surgical_case.requested_date, requested_time (user's preferred vs scheduled date)

017_drop_patient_mrn.sql
Removes: surgical_case.patient_mrn (PHI removed from surgical_case)

018_case_request_approval_workflow.sql
Extends case_status enum with: REQUESTED, REJECTED
Adds: surgical_case.rejected_at, rejected_by_user_id, rejection_reason

019_case_request_approval_columns.sql
Adds: surgical_case.is_cancelled, cancelled_at, cancelled_by_user_id

020_case_number.sql
Adds: surgical_case.case_number UNIQUE NOT NULL, function generate_case_number(facility_id)

021_multi_role_support.sql
Adds: app_user.roles user_role[] (allows cross-trained staff multiple roles)

022_facility_config_items.sql
Creates: facility_config_item
Enum: config_item_type

023_room_scheduling.sql
Creates: block_time, room_day_config

024_room_sort_order.sql
Adds: room.sort_order

025_surgeon_color.sql
Adds: room.surgeon_color (for calendar color coding)

026_checklist_flag_for_review.sql
Index optimization for flagged checklist signatures

027_checklist_flag_comment.sql
Schema validation for flagged_for_review and flag_comment relationship

028_surgeon_checklist_feedback.sql
Additional indexes for surgeon-specific checklist queries

029_admission_types.sql
Adds: surgical_case.admission_type TEXT

030_catalog_v1_1_risk_intent.sql
Enum: criticality
Adds: item_catalog.requires_lot_tracking, requires_serial_tracking, requires_expiration_tracking, criticality, readiness_required, expiration_warning_days, substitutable

031_catalog_groups.sql
Creates: catalog_group, catalog_group_membership

032_align_categories_with_law.sql
Replaces item_category enum: old (IMPLANT, INSTRUMENT, LOANER, HIGH_VALUE_SUPPLY)  new (IMPLANT, INSTRUMENT, EQUIPMENT, MEDICATION, CONSUMABLE, PPE)
Migration: LOANER  INSTRUMENT, HIGH_VALUE_SUPPLY  EQUIPMENT

033_catalog_set_components.sql
Creates: catalog_set_component
Adds: item_catalog.is_container

034_catalog_item_images.sql
Creates: catalog_image

035_case_card_composition.sql
Schema refactoring for case card composition

036_case_status_events.sql
Creates: surgical_case_status_event (append-only audit log of status transitions)

037_catalog_event.sql
Creates: catalog_event (append-only audit log of catalog changes)

038_barcode_support.sql
Adds: inventory_item.barcode_gtin, barcode_parsed_lot, barcode_parsed_serial, barcode_parsed_expiration, barcode_classification (GS1 barcode parsing)

039_roles_canonical.sql
Backfill: app_user.roles from app_user.role where NULL/empty
Adds: CHECK constraint app_user.roles array_length >= 1
Comments: app_user.role marked as DEPRECATED

040_idempotency_keys.sql
Creates: idempotency_key (for API idempotency)

041_case_preop_phase.sql
Extends case_status enum with: IN_PREOP
Adds: surgical_case.checked_in_preop_at, checked_in_preop_by_user_id

042_case_preop_columns.sql
Additional indexes for preop phase queries

043_financial_attribution.sql
Creates: vendor, loaner_set, source_event
Enums: vendor_type, ownership_type, source_event_type, cost_override_reason, gratis_reason

044_catalog_container_flag.sql
Validation for item_catalog.is_container (only INSTRUMENT/EQUIPMENT allowed as containers)

045_platform_admin_role.sql
Extends user_role enum with: PLATFORM_ADMIN
Allows: app_user.facility_id NULL for PLATFORM_ADMIN
Adds: UNIQUE constraint on (facility_id, username) with NULL facility_id allowed once

046_platform_admin_constraints.sql
Validation: PLATFORM_ADMIN users must have facility_id = NULL

047_config_registry.sql
Creates: config_registry, config_value
Enums: config_scope, config_value_type, config_risk_class

048_auth_audit_log.sql
Creates: auth_audit_log (append-only audit log of authentication events)

049_case_card_link_events.sql
Creates: case_card_link_event (append-only audit log of preference card linking)

050_location_active_status.sql
Adds: location.active

051_organization_model.sql
Creates: organization
Enum: organization_type
Backfill: Creates ASC organization for each existing facility
Constraint: Exactly one active ASC organization per facility

052_user_organization_affiliation.sql
Creates: user_organization_affiliation
Enum: affiliation_type
Backfill: Creates PRIMARY affiliation for all existing users to their facility's ASC organization

053_case_attribution_and_grants.sql
Creates: surgical_case_access_grant
Adds: surgical_case.primary_organization_id
Backfill: Sets primary_organization_id to facility's ASC organization for all cases

054_phi_access_audit_log.sql
Creates: phi_access_log, phi_access_log_detail
Enums: phi_classification, access_purpose, access_outcome

055_phi_phase3_audit_extensions.sql
Schema extensions for PHI audit analytics

056_phi_phase4_retention_breach.sql
Creates: phi_retention_policy_cache, phi_breach_log

057_phi_phase6_patient_identity.sql
Adds: surgical_case.patient_initials, patient_date_of_birth (minimal patient identity for timeout)

058_phi_patient_gender.sql
Enum: gender
Adds: surgical_case.patient_gender

059_surgery_request.sql
Creates: clinic, clinic_api_key, patient_ref, surgery_request, surgery_request_submission, surgery_request_checklist_template_version, surgery_request_checklist_instance, surgery_request_checklist_response, surgery_request_audit_event, surgery_request_conversion
Enums: surgery_request_status, surgery_request_event_type, surgery_request_checklist_status, surgery_request_actor_type

060_financial_readiness.sql
Creates: clinic_financial_declaration, asc_financial_verification, financial_override, financial_readiness_cache
Enums: clinic_financial_state, asc_financial_state, override_state, financial_risk_state, override_reason_code

061_backfill_missing_affiliations.sql
Backfill: Ensures all users have at least one PRIMARY affiliation (repair for edge cases)

================================================================================
5. SEED DATA OR FIXTURES
================================================================================

Seed Script Location:
apps/api/db/seed.ts

Seeding Strategy:
Two-phase seeding:
  Phase 1: Platform bootstrap (lines 30-55)
    - ALWAYS runs (idempotent)
    - Creates PLATFORM_ADMIN user (username: platform-admin)
    - Password from PLATFORM_ADMIN_PASSWORD env var, defaults to 'platform123'
    - Skips if platform-admin user already exists
  Phase 2: Demo/tenant data (lines 67-685)
    - Runs once (checks for existing facility records)
    - Can be reset with --reset flag (TRUNCATE facility CASCADE, clinic CASCADE)
    - Creates demo facility, organization, users, locations, catalog, inventory, preference cards, cases, surgery requests

When/How Loaded:
Command: npm run db:seed (from apps/api/package.json line 14)
Invoked manually after migrations
Environment variables: SEED_FACILITY_KEY (default: ORTHOWISE_BETA), PLATFORM_ADMIN_PASSWORD, CLINIC_KEY_SECRET

Seed Data Created (Phase 2):
Facility:
  1 facility (name: Demo Surgery Center, facility_key from SEED_FACILITY_KEY env)
  1 ASC organization for the facility

Users (7 tenant users + 1 platform admin):
  admin / password123 (ADMIN)
  scheduler / password123 (SCHEDULER)
  tech / password123 (INVENTORY_TECH)
  circulator / password123 (CIRCULATOR)
  scrub / password123 (SCRUB)
  drsmith / password123 (SURGEON)
  drjones / password123 (SURGEON)
  All auto-affiliated to facility's ASC organization

Locations (4):
  OR Storage Room A, OR Storage Room B, Sterile Processing, Loaner Storage

Catalog Items (9):
  Hip Stem Size 12/14, Acetabular Cup 54mm, Knee Tibial Tray, Arthroscopy Scope/Shaver, Power Drill, Vendor Specialty Tray (loaner, intentionally NOT in inventory for red case demo), Surgical Mesh x2

Inventory Items (8):
  All catalog items except Vendor Specialty Tray, all STERILE, sterility expires in 7 days

Preference Cards (3):
  Total Hip Arthroplasty (Dr. Smith)
  Total Knee Arthroplasty (Dr. Jones)
  Lumbar Fusion (Dr. Smith, requires missing loaner tray)

Surgical Cases (18 total):
  3 primary cases (tomorrow): 1 green hip, 1 green knee, 1 red spine (missing loaner)
  15 test cases (days +2, +3, +4): 5 cases per day for debrief testing
  All cases are ACTIVE (is_active=true) with status SCHEDULED
  All have case_number generated, primary_organization_id set to ASC org

Devices (1):
  Scanner Station A (barcode scanner in OR Storage Room A)

Surgery Request Data (Phase 1 Readiness):
Clinic:
  1 clinic (Demo Ortho Clinic, clinic_key: DEMO_CLINIC)
  1 clinic API key (raw key logged in seed output, key_hash stored with HMAC-SHA256)

Checklist Template:
  1 template version (Clinic Readiness, 4 items: H&P, labs, consent, surgical site)

Patient Refs (3):
  PAT-001 (John Doe, birth_year 1965)
  PAT-002 (Jane Smith, birth_year 1978)
  PAT-003 (Bob Wilson, birth_year 1952)

Surgery Requests (3):
  SR1: SUBMITTED (Right TKA, Dr. Jones, tomorrow, checklist COMPLETE)
  SR2: ACCEPTED (Left Hip, Dr. Smith, day +2, submitted 2 days ago)
  SR3: CONVERTED (Lumbar Decompression, Dr. Smith, day +3, linked to surgical_case)

Financial Readiness Data (Phase 2):
  SR1: clinic DECLARED_CLEARED, ASC UNKNOWN  risk UNKNOWN
  SR2: clinic DECLARED_CLEARED, ASC VERIFIED_CLEARED  risk LOW
  SR3: clinic DECLARED_AT_RISK, ASC VERIFIED_AT_RISK, override OVERRIDE_CLEARED  risk LOW

Seed Output:
Logs credentials and API keys to console (apps/api/db/seed.ts lines 687-698)
Platform admin and tenant user credentials
Clinic API key (raw key, never stored)

================================================================================
6. FACTUAL INCONSISTENCIES OR DUPLICATIONS
================================================================================

Deprecated Column:
app_user.role (singular) is deprecated as of migration 039_roles_canonical.sql
Authorization code must read app_user.roles[] (array) exclusively
The role column is kept for backward compatibility but marked DEPRECATED via database comment
Risk: Code that reads app_user.role instead of roles[] will have incomplete authorization data

Nullable Facility ID:
app_user.facility_id is nullable ONLY for PLATFORM_ADMIN users (migration 045)
All other roles require non-null facility_id
Constraint: UNIQUE (facility_id, username) allows NULL facility_id once
Risk: Queries that assume facility_id NOT NULL will miss PLATFORM_ADMIN users

Enum Replacement:
item_category enum was replaced in migration 032_align_categories_with_law.sql
Old values (LOANER, HIGH_VALUE_SUPPLY) migrated to new schema (INSTRUMENT, EQUIPMENT)
No data duplication, but code written before migration 032 may reference obsolete enum values
Source files: apps/api/db/migrations/001_initial_schema.sql (original) vs 032_align_categories_with_law.sql (replacement)

Attestation Voiding vs Deletion:
attestation table is append-only (NO DELETE allowed)
Voiding implemented via is_voided boolean flag (migration 002)
Voided attestations remain in table with voided_at/voided_by_user_id
No deletion mechanism exists per LAW requirements
Factual observation: Voided attestations are not excluded from queries by default (application must filter)

Multiple Sources of Truth for Case Requirements:
Case requirements can exist in:
  1. preference_card_version.items (JSONB, immutable snapshot)
  2. case_card_item (mutable, case-specific overrides)
  3. case_requirement (final resolved requirements)
Source files: apps/api/db/migrations/001_initial_schema.sql (preference_card_version), 011_case_cards.sql (case_card_item), 001_initial_schema.sql (case_requirement)
Factual observation: These are intentionally separate (version history vs current state vs overrides) but application must reconcile

Seed Data Timing:
Migrations 051-053 backfill organization, affiliation, and case attribution for existing data
If seed script runs AFTER migrations, backfills are no-ops (no existing data to backfill)
If seed script runs BEFORE migrations, seed data is backfilled
Seed script (apps/api/db/seed.ts lines 96-141) now handles organization/affiliation creation itself to work in either order
Source files: apps/api/db/seed.ts, apps/api/db/migrations/051_organization_model.sql, 052_user_organization_affiliation.sql, 053_case_attribution_and_grants.sql

Cached vs Event Tables:
Mutable cache tables recomputed from append-only event tables:
  case_readiness_cache  computed from inventory_item, case_requirement, attestation
  financial_readiness_cache  computed from clinic_financial_declaration, asc_financial_verification, financial_override
  phi_retention_policy_cache  computed from surgical_case, phi_access_log
Factual observation: Cache staleness is possible if recomputation logic fails
Source files: apps/api/db/migrations/001_initial_schema.sql (case_readiness_cache), 060_financial_readiness.sql (financial_readiness_cache), 056_phi_phase4_retention_breach.sql (phi_retention_policy_cache)

Database Functions (Not Stored in Migrations):
generate_case_number(facility_id UUID) introduced in migration 020
prevent_modification() introduced in migration 001
update_updated_at() introduced in migration 001
No duplication, but function definitions are embedded in migration SQL files (not separate schema objects)
Source: apps/api/db/migrations/001_initial_schema.sql (lines 383-427), 020_case_number.sql

END OF SNAPSHOT
